# GPU&NPUæ— éš¾åº¦ä¸Šæ‰‹GRPOå¼ºåŒ–å­¦ä¹ è®­ç»ƒæ•™ç¨‹ï¼Œæ•™ä½ å¤ç°æ•°ç‹¬å°æ¸¸æˆ

## ç®€ä»‹

æœ€è¿‘åœ¨è¡¥å……NLPä»»åŠ¡é¢†åŸŸçš„GRPOå¼ºåŒ–å­¦ä¹ è®­ç»ƒä»»åŠ¡ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨GRPOå®ç°ä¸€ä¸ªç®€å•çš„æ•°ç‹¬æ¸¸æˆã€‚

æˆ‘ä»¬éƒ½çŸ¥é“å¤§è¯­è¨€æ¨¡å‹ç°åœ¨èƒ½å¤Ÿå®Œæˆå¤šç±»ä»»åŠ¡ï¼ŒåŒ…æ‹¬é—®ç­”ä»»åŠ¡ã€æ·±å…¥çš„å¤šè½®å¯¹è¯ã€è¿˜æœ‰ä»£ç å’Œæ•°å­¦é—®é¢˜ç­‰ç­‰ï¼Œæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„å®˜ç½‘ä¸­ä¹Ÿæœ‰å¾ˆå¤šå¯¹åº”çš„å®è·µæ•™ç¨‹æ¯”å¦‚æŒ‡ä»¤å¾®è°ƒã€æ¨ç†æ¨¡å‹çš„å¾®è°ƒä»»åŠ¡ç­‰ã€‚

ä½†æ˜¯æ•°ç‹¬æ¸¸æˆæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€ƒéªŒæ¨¡å‹é€»è¾‘æ€ç»´èƒ½åŠ›ä»¥åŠæ¨ç†èƒ½åŠ›çš„ä»»åŠ¡ï¼Œä¸€èˆ¬çš„SFTä»…èƒ½åšåˆ°éµä»æŒ‡ä»¤å›ç­”è€Œä¸èƒ½è®©æ¨¡å‹å…·å¤‡å¤æ‚çš„æ¨ç†èƒ½åŠ›ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨å¼ºåŒ–å­¦ä¹ çš„æ–¹æ³•æ¥å®ç°æ•°ç‹¬æ¸¸æˆçš„è®­ç»ƒã€‚æœ¬æ¬¡å®éªŒæˆ‘ä»¬ä½¿ç”¨GRPOçš„æ–¹æ³•ï¼Œç”¨loraæ¥åšå¾®è°ƒï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨GPUã€NPUçš„AIè®­ç»ƒå¡ä¸Šè®­ç»ƒï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯¹æ¯”äº†3Bæ¨¡å‹ã€7Bæ¨¡å‹çš„è®­ç»ƒæ•ˆæœï¼Œå¹¶ä¸”é€šè¿‡ä¸æ–­åœ°è°ƒæ•´å‚æ•°å®ç°æœ€ç»ˆå‡†ç¡®åº¦è¾¾åˆ°89%ã€‚

æœ¬æ¬¡æ•™ç¨‹æˆ‘ä»¬å°†å®Œæ•´çš„è¿‡ç¨‹å±•ç°ï¼Œä»æ•°æ®ç”Ÿæˆã€è®­ç»ƒæ¡†æ¶è®¾è®¡ã€åˆ°æœ€åçš„è¯„æµ‹ç¯èŠ‚ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ä»£ç ã€å¯è§†åŒ–ç»“æœå¼€æºï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±å®è·µä¸‹ï¼Œä¹Ÿå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„çš„ä»£ç æ¥åšå…¶ä»–çš„ä»»åŠ¡ã€‚

## æ•°ç‹¬æ¸¸æˆçš„éš¾ç‚¹

å½“å‰çš„è¯­è¨€æ¨¡å‹è¿˜æ˜¯ä»¥ARï¼ˆè‡ªå›å½’ï¼‰æ¨¡å‹ä¸ºä¸»ï¼Œä¸»è¦è¿˜æ˜¯æ ¹æ®å†å²æ¥é¢„æµ‹åç»­æ–‡æœ¬å†…å®¹ï¼Œè€Œæ•°ç‹¬æ¸¸æˆå¤§å¤šéœ€è¦æ€è€ƒæ¨ç†ã€åæ€çº é”™ç­‰ï¼Œå¹¶ä¸”æ•°ç‹¬æ¸¸æˆåº”è¯¥æ˜¯ä»¥ç»“æ„åŒ–æ–‡æœ¬çš„å½¢å¼è¾“å…¥å’Œè¾“å‡ºï¼Œè¯­è¨€æ¨¡å‹å°¤å…¶æ˜¯ç°åœ¨çš„é€šç”¨æ¨¡å‹æœ¬èº«å°±ä¸æ˜¯ä¸ºäº†ç»“æ„åŒ–é—®é¢˜è€Œè®¾è®¡ï¼Œä½†æ˜¯é€šè¿‡å¼ºåŒ–å­¦ä¹ è®­ç»ƒè®©æ¨¡å‹æŒæ¡äº†å¤æ‚çš„æ¨ç†èƒ½åŠ›å°±èƒ½è®©æˆ‘ä»¬å­¦ä¼šè¿™äº›æŠ€èƒ½ã€‚

æˆ‘ä»¬æ€»ç»“ä¸‹ï¼Œæ•°ç‹¬æ¸¸æˆçš„æ¨¡å‹è®­ç»ƒæœ‰ä¸‹é¢å‡ ä¸ªéš¾ç‚¹ï¼š

- éµå®ˆå¤æ‚çš„è§„åˆ™ï¼ˆæˆ‘ä»¬æ˜¯4*4çš„æ•°ç‹¬æ¸¸æˆï¼‰ï¼šæ¯è¡Œã€æ¯åˆ—ã€æ¯ä¸€ä¸ª2\*2å°æ ¼å­ä¸é‡å¤ï¼Œåœ¨1-4ä¹‹é—´é€‰æ•°å­—

- ä¿æŒä¸€è‡´çš„æ ¼å¼ï¼šæˆ‘ä»¬é‡‡ç”¨åˆ—è¡¨æ ¼å¼æ¥å‚¨å­˜æˆ‘ä»¬çš„ç»“æœï¼Œæ¯”å¦‚[[1,4,3,2],[3,2,1,4],[2,1,4,3],[4,3,2,1]\]

- æ¨¡å‹åº”è¯¥å…·å¤‡å¤æ‚çš„é€»è¾‘æ¨ç†èƒ½åŠ›

æˆ‘ä»¬åœ¨kaggleä¸Šæœ‰æ‰¾è¿‡æ•°ç‹¬æ¸¸æˆçš„æ•°æ®ï¼Œä¸è¿‡åŸºæœ¬éƒ½æ˜¯9\*9çš„ï¼Œ9\*9çš„å¯¹èµ„æºçš„è¦æ±‚æœ‰ç‚¹å¤ªé«˜äº†ï¼Œå› æ­¤æˆ‘ä»¬æœ€å¼€å§‹å°±æƒ³å¼„4\*4çš„æ•°ç‹¬ï¼Œæ¨¡å‹ä¸éœ€è¦æ€è€ƒå¤ªé•¿ï¼Œå¹¶ä¸”ç›¸å¯¹æ¥è¯´é—®é¢˜æ¯”è¾ƒç®€å•ï¼Œèƒ½åœ¨è¾ƒå°‘çš„èµ„æºæ¡ä»¶ä¸‹å–å¾—è¾ƒå¤§çš„æå‡ï¼Œèƒ½æœ‰æ•ˆåœ°æé«˜æ¨¡å‹çš„æ¨ç†èƒ½åŠ›å³å¯ã€‚

åŒæ—¶ï¼Œ4\*4æ•°ç‹¬çš„æ•°æ®ï¼Œå®Œæ•´ç¬¦åˆè§„åˆ™çš„å°±åªæœ‰288æ¡æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¾ç½®é—®é¢˜çš„æ—¶å€™éšæœºæŒ–ç©ºï¼Œæ‰©å¤§è¿™ä¸ªæ•°æ®é›†ï¼Œä½†æ˜¯æœ¬èº«æ¯”èµ·9\*9çš„æ•°æ®å°‘äº†å¾ˆå¤šï¼Œæˆ‘ä»¬ç”Ÿæˆæ•°æ®çš„æ—¶å€™ä¹Ÿèƒ½æ–¹ä¾¿äº›ã€‚

ä¸‹é¢æ˜¯4\*4æ•°ç‹¬çš„ä¸€ä¸ªä¾‹å­ï¼š

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train1.png" style="width:90%">
  </figure>
</div>

æˆ‘ä»¬ä¼šéšæœºåœ¨å…¶ä¸­æŒ–å‡ ä¸ªç©ºåšä¸ºé—®é¢˜ï¼Œé€šè¿‡GRPOçš„è®­ç»ƒè®©æ¨¡å‹å­¦ä¼šè‡ªä¸»æ€è€ƒï¼Œå¹¶ä¸”å¡«å†™å…¶ä¸­è¢«æŒ–å»çš„éƒ¨åˆ†ã€‚ï¼ˆå®é™…è®­ç»ƒçš„æ—¶å€™æˆ‘ä»¬ä¸æ˜¯ç”¨çš„ç½‘æ ¼æ ¼å¼ï¼Œè€Œæ˜¯ä¸Šé¢æåˆ°çš„åˆ—è¡¨æ ¼å¼ï¼Œè¿™ä¸ªç”¨ç½‘æ ¼åªæ˜¯ä¸ºäº†å½¢è±¡çš„å±•ç¤ºï¼‰

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train2.png" style="width:90%">
  </figure>
</div>

## å¥–åŠ±å‡½æ•°è®¾è®¡çš„éš¾ç‚¹

å¯¹äºä¸€èˆ¬çš„æ•°å­¦é—®é¢˜ï¼Œå¥–åŠ±å‡½æ•°åŸºæœ¬å°±æ˜¯æ ¼å¼ã€å›ç­”å‡†ç¡®åº¦ç›¸å…³ï¼Œä½†æ˜¯å¯¹äºæ•°ç‹¬ï¼Œæˆ‘ä»¬è¦è€ƒè™‘ä¸‹é¢å‡ ç‚¹ï¼š

1. åŒä¸€ä¸ªé—®é¢˜å¯èƒ½å›ç­”çš„ç»“æœä¸ä¸€æ ·ï¼Œä½†å¯èƒ½ç¬¦åˆæ•°ç‹¬æ¸¸æˆè§„åˆ™ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ä»¥å•çº¯çš„å¯¹é”™æ¥è®¾è®¡è§£ç­”çš„å‡†ç¡®åº¦å¥–åŠ±ï¼Œè€Œåº”è¯¥ä»¥è§„åˆ™çš„éµå®ˆç¨‹åº¦æ¥è®¾è®¡å¥–åŠ±å‡½æ•°ï¼Œæ¯”å¦‚æ¯è¡Œã€æ¯åˆ—ã€æ¯ä¸ªå°æ ¼å­æ˜¯å¦éƒ½éµå®ˆäº†è§„åˆ™ï¼Œå¦‚æœæ²¡æœ‰éµå®ˆï¼Œé”™äº†å¤šå°‘ä¸ªå°±æ‰£å¤šå°‘åˆ†ã€‚

2. å¯¹äºæ ¼å¼ï¼Œé™¤äº†å•çº¯çš„\<think>\</think>ã€\<answer>\</answer>ï¼Œæˆ‘ä»¬æ›´åº”è¯¥å…³æ³¨æœ€ç»ˆå›ç­”çš„ç»“æœæ˜¯å¦æ˜¯ç»“æ„åŒ–æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯æ˜¯å¦æ˜¯Listæ ¼å¼ï¼Œé‡Œé¢çš„æ•°å­—æ˜¯å¦æ˜¯16ä¸ªè¿™æ ·çš„æƒ…å†µ

3. **æˆ‘ä»¬åœ¨å®é™…å®éªŒçš„æ—¶å€™å‘ç°ï¼Œå› ä¸ºæ¨¡å‹æ˜¯é¢„æµ‹åé¢çš„æ–‡æœ¬å†…å®¹ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬ä¹ æƒ¯çš„å¡«å†™æ•°ç‹¬åŒæ—¶ä¿ç•™é—®é¢˜ï¼Œæ¨¡å‹æ˜¯å…¨éƒ¨è¾“å‡ºï¼Œå› æ­¤ä¼šé‡åˆ°æ¨¡å‹æ”¹é¢˜çš„æƒ…å†µï¼Œå¯¹äºé—®é¢˜çš„ä¿æŒä¹Ÿè¦è®¾ç½®ä¸ºå¥–åŠ±å‡½æ•°ã€‚**

# é“¾æ¥èµ„æ–™

æœ¬æ¬¡æ•™ç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨trlæ¡†æ¶åšGRPOè®­ç»ƒï¼Œæˆ‘ä»¬çš„æ‰€æœ‰ä»£ç å·²ç»å¼€æºåˆ°githubä¸­ï¼ŒåŒæ—¶è®­ç»ƒè¿‡ç¨‹çš„è§‚æµ‹ç»“æœæˆ‘ä»¬æ”¾åœ¨äº†swanlabä¸­ï¼Œå…·ä½“çš„é“¾æ¥å¦‚ä¸‹ï¼š

- ä»£ç é“¾æ¥ï¼š[github](https://github.com/828Tina/sudoku_trl_grpo?tab=readme-ov-file)
- æ¨¡å‹é“¾æ¥ï¼š[modelscope/qwen2.5-3b-instruct](https://www.modelscope.cn/models/Qwen/Qwen2.5-3B-Instruct)ã€[modelscope/qwen2.5-7b-instruct](https://www.modelscope.cn/models/Qwen/Qwen2.5-7B-Instruct)
- swanlabç»“æœï¼š[SwanLab](https://swanlab.cn/@LiXinYu/sudoku-grpo-qwen2.5/overview)

å‹æƒ…é“¾æ¥ï¼š

- trlä»£ç ï¼š[huggingface/trl](https://github.com/huggingface/trl)

- GRPOTrainerï¼š[huggingface/TRL/GRPOTrainer](https://huggingface.co/docs/trl/grpo_trainer)

- SwanLabå®˜æ–¹æ–‡æ¡£ï¼ŒåŠ©ä½ è½»æ¾å¼€å¯æ·±åº¦å­¦ä¹ ä¹‹æ—…ï¼š
  
  > [æ¡†æ¶é›†æˆæ–‡æ¡£](https://docs.swanlab.cn/guide_cloud/integration/)ï¼šSwanLabå·²ç»é›†æˆTransformersã€LLaMA Factoryã€Pytorchç­‰ä¸»æµæ¡†æ¶ï¼Œå¹¶æŒç»­æ›´æ–°
  > [å®æˆ˜æ¡ˆä¾‹](https://docs.swanlab.cn/examples/hello_world.html)ï¼šSwanLabæä¾›äº†ä¸°å¯Œçš„æ¨¡å‹è®­ç»ƒå®æˆ˜æ•™ç¨‹ï¼ŒåŠ©åŠ›ç”¨æˆ·å¿«é€ŸæŒæ¡æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„è¦ç‚¹

ä½œè€…ï¼šæƒ…æ„Ÿæœºå™¨å®éªŒå®¤ç ”ç©¶å‘˜-æé¦¨é›¨ é‚®ç®±ï¼šwind.340171@gmail.com

# GRPOåŸç†

å…³äºGRPOçš„åŸç†ï¼Œç”±äºæœ¬æ•™ç¨‹æ›´å¤šæ˜¯å®è·µå¦‚ä½•å®ç°GRPOçš„è®­ç»ƒï¼Œè¿™é‡Œæˆ‘å°±ç®€å•è®²è¿°ä¸‹GRPOåšäº†ä»€ä¹ˆï¼Œå¦‚æœå¯¹GRPOåŸç†æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å‚è€ƒä¸€äº›èµ„æ–™ã€‚

- [å›¾è§£å¤§æ¨¡å‹RLHFç³»åˆ—ä¹‹ï¼šäººäººéƒ½èƒ½çœ‹æ‡‚çš„PPOåŸç†ä¸æºç è§£è¯»](https://zhuanlan.zhihu.com/p/677607581)
- [DeepSeekMath: Pushing the Limits of Mathematical Reasoning in Open Language Models](https://arxiv.org/abs/2402.03300)
- [LLM-RL-Visualized](https://github.com/changyeyu/LLM-RL-Visualized)

GRPOï¼ˆGroup Relative Policy Optimizationï¼Œç¾¤ä½“ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–ï¼‰æœ¬è´¨æ˜¯å¯¹PPOï¼ˆProximal Policy Optimizationï¼Œè¿‘ç«¯ç­–ç•¥ä¼˜åŒ–ï¼‰çš„ä¼˜åŒ–ï¼Œæ‰€ä»¥å¦‚æœGRPOæ²¡çœ‹æ‡‚ï¼Œé‚£å¤§æ¦‚ç‡æ˜¯PPOæ²¡æœ‰ææ‡‚ï¼Œå¦‚æœPPOæ²¡ææ‡‚ï¼Œé‚£å¤§æ¦‚ç‡æ˜¯actor-criticæ¡†æ¶æ²¡ææ‡‚ï¼Œä¸‹é¢æˆ‘ä»¬ç®€å•åœ°ä»å¤´åˆ°å°¾æ¢³ç†ä¸‹ã€‚

æˆ‘å¸Œæœ›è¿™éƒ¨åˆ†æ›´å¤šæ˜¯è®©è¯»è€…æ˜ç™½GRPOç›¸æ¯”äºå‰äººåšäº†ä»€ä¹ˆä¼˜åŒ–ï¼Œå¦‚æœæ˜¯æ›´è¯¦ç»†çš„åŸç†ï¼Œå¯ä»¥å‚è€ƒä¸‹[è¿™ç¯‡æ–‡ç« ](https://github.com/changyeyu/LLM-RL-Visualized)ï¼Œæˆ‘å°±æ˜¯æ ¹æ®è¿™ä¸ªæ¥å­¦çš„ã€‚

**LLMå¼ºåŒ–å­¦ä¹ åŸºç¡€æ¶æ„**

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train21.png" style="width:80%">
  </figure>
</div>

`æ™ºèƒ½ä½“Agent`é€šå¸¸æ¥è¯´ä¹Ÿå°±æ˜¯å¤§æ¨¡å‹ï¼Œæ˜¯è´Ÿè´£å†³ç­–`åŠ¨ä½œ`çš„å®ä½“ï¼Œæ ¹æ®å½“å‰æ‰€å¤„`çŠ¶æ€`å’Œç¯å¢ƒç»™äºˆçš„`å¥–åŠ±`æ¥å†³ç­–ä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚

`ç¯å¢ƒ`æ˜¯`æ™ºèƒ½ä½“Agent`å†³ç­–å¥½`åŠ¨ä½œ`åï¼Œä¸`ç¯å¢ƒ`äº¤äº’å®ŒæˆçŠ¶æ€è½¬ç§»å¹¶ç”Ÿæˆå¯¹åº”`å¥–åŠ±`ï¼Œä¸ºä¸‹ä¸€æ­¥`æ™ºèƒ½ä½“Agent`å†³ç­–æä¾›ä¿¡æ¯ã€‚

å› æ­¤`æ™ºèƒ½ä½“Agent`å’Œ`ç¯å¢ƒ`åˆ†åˆ«åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

- `æ™ºèƒ½ä½“Agent`ï¼šç­–ç•¥æ¨¡å‹
- `ç¯å¢ƒ`ï¼šçŠ¶æ€ç©ºé—´ã€åŠ¨ä½œç©ºé—´ã€å¥–åŠ±å‡½æ•°ï¼ˆ&æ¨¡å‹ï¼‰ã€çŠ¶æ€è½¬ç§»æ¦‚ç‡

å¼ºåŒ–å­¦ä¹ å…¶å®å°±æ˜¯è§£å†³è¿™ä¸¤éƒ¨åˆ†å†…å®¹ã€‚

å…¶ä¸­ç­–ç•¥æ¨¡å‹æ˜¯åšå†³ç­–ã€ç”ŸæˆåŠ¨ä½œç”¨çš„ï¼Œåœ¨NLPé¢†åŸŸé€šå¸¸æ˜¯å¤§æ¨¡å‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå†³ç­–å…¶å®å…·ä½“å°±æ˜¯ç”Ÿæˆä¸‹ä¸€ä¸ªtokenã€‚

ç„¶åå¯¹äºç¯å¢ƒæ¥è¯´ï¼ŒçŠ¶æ€ç©ºé—´å°±æ˜¯æ— æ•°çš„å†å²å¯¹è¯ï¼ŒåŠ¨ä½œç©ºé—´å°±æ˜¯å¤§æ¨¡å‹å¯¹åº”çš„å­—å…¸è§„æ¨¡ï¼Œæ¯ä¸€ä¸ªçŠ¶æ€å¯èƒ½æœ‰ä¸€ä¸ªè½¬ç§»æ¦‚ç‡ï¼Œæ¯ä¸€ä¸ªåŠ¨ä½œå¯èƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å¥–åŠ±ã€‚

> åœ¨å®é™…è®­ç»ƒçš„æ—¶å€™ï¼Œå“ªä¸€éƒ¨åˆ†æ›´éš¾å‘¢ï¼Ÿ
> æ˜¾ç„¶æ˜¯å¥–åŠ±å‡½æ•°çš„è®¾è®¡ï¼Œç­–ç•¥æ¨¡å‹åªè¦æ ¹æ®å¥–åŠ±å’ŒçŠ¶æ€æ¥æ›´æ–°å‚æ•°å°±è¡Œäº†ï¼Œè€Œå¥–åŠ±å‡½æ•°éœ€è¦è€ƒè™‘çš„å°±å¾ˆå¤šäº†ã€‚å½“å‰LLMçš„åŠ¨ä½œç©ºé—´ä¹Ÿå°±æ˜¯å­—å…¸è§„æ¨¡éƒ½æ˜¯10w+çš„ï¼Œæ›´åˆ«è¯´çŠ¶æ€ç©ºé—´äº†ï¼Œå› æ­¤å¦‚ä½•è®¾è®¡å¥–åŠ±å‡½æ•°ä½¿å¾—æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­çš„å¤æ‚åº¦ã€æ–¹å·®ç­‰æŒ‡æ ‡æ›´å°å°±æ˜¯åé¢çš„å„ç§è®­ç»ƒæ–¹æ³•éœ€è¦æ€è€ƒçš„ã€‚

é‚£ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹actor-criticæ¡†æ¶åšäº†ä»€ä¹ˆã€‚

**actor-criticæ¡†æ¶åŸç†**

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train22.png" style="width:80%">
  </figure>
</div>

- `Actor Model`:ç­–ç•¥æ¨¡å‹$\pi$ï¼Œè´Ÿè´£é€‰æ‹©åŠ¨ä½œï¼Œç›´æ¥è¾“å‡ºç­–ç•¥$\pi(a|s)$ï¼Œä¹Ÿå°±æ˜¯åœ¨ç»™å®šçŠ¶æ€sä¸‹æ‰§è¡ŒåŠ¨ä½œaçš„æ¦‚ç‡åˆ†å¸ƒã€‚

- `Critic Model`:ä»·å€¼æ¨¡å‹Qï¼Œæ¥è¯„ä¼°`Actor Model`æ‰§è¡Œçš„åŠ¨ä½œçš„å¥½åï¼ŒååŠ©`Actor Model`é€‰æ‹©åŠ¨ä½œï¼Œé€æ­¥ä¼˜åŒ–å‚æ•°$\theta$ã€‚

åœ¨ç†è§£è¿™å¼ å›¾å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®ï¼Œå¯¹äºä¸€ä¸ªåŠ¨ä½œçš„å¥½åï¼Œæˆ‘ä»¬ä¸ä»…è¦è€ƒè™‘è¿™ä¸ªåŠ¨ä½œæ‰§è¡Œåèƒ½è·å¾—çš„å³æ—¶å¥–åŠ±ï¼Œä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªåŠ¨ä½œæœªæ¥èƒ½å¤Ÿç»™äºˆæˆ‘çš„å›æŠ¥ï¼Œä¹Ÿå°±æ˜¯â€œçœ¼å…‰æ”¾é•¿è¿œâ€ã€‚

æŸä¸ªåŠ¨ä½œå¯¹åº”çš„é‚£ä¸ªå¥–åŠ±æˆ‘ä»¬å¯ä»¥è½»æ¾å¾—å‡ºï¼Œä½†æ˜¯æœªæ¥çš„å›æŠ¥æˆ‘ä»¬å¾ˆéš¾ç›´æ¥è·å¾—ã€‚è¿™å¾ˆå¥½ç†è§£ï¼Œå¯¹äºå¤§æ¨¡å‹æ¥è¯´ï¼Œé¢„æµ‹ä¸‹ä¸€ä¸ªtokenæ˜¯ç®€å•çš„ï¼Œä½†æ˜¯åœ¨é¢„æµ‹ä¸‹ä¸€ä¸ªtokençš„åŒæ—¶ä¸€æ¬¡æ€§é¢„æµ‹åé¢æ‰€æœ‰çš„tokenså¹¶å°†åé¢çš„æ¦‚ç‡å…¨éƒ¨è¿”å›ï¼Œè¿™å¹¶ä¸å¯è¡Œï¼Œå› ä¸ºå¤§æ¨¡å‹å¤§å¤šæ˜¯ARæ¨¡å‹ã€‚

é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªæ¨¡å‹æ¥è®­ç»ƒè¿™ä¸ªæœªæ¥å›æŠ¥æ‰€ä»£è¡¨çš„ä»·å€¼å‡½æ•°ï¼Œè¿™å°±æ˜¯`Critic Model`åšçš„äº‹ã€‚

æ—©æœŸçš„`actor-criticæ¨¡å‹`ä»·å€¼æ¨¡å‹è®­ç»ƒçš„æ˜¯åŠ¨ä½œä»·å€¼å‡½æ•°ï¼ŒåŠ¨ä½œä»·å€¼å‡½æ•°ä¸ä¹‹ç›¸å¯¹çš„è¿˜æœ‰ä¸€ä¸ªçŠ¶æ€ä»·å€¼å‡½æ•°ï¼Œç®€å•è¯´ä¸‹æ¦‚å¿µï¼š

- `åŠ¨ä½œä»·å€¼å‡½æ•°Q(a,s)`:åœ¨ç­–ç•¥$\pi$ä¸‹ï¼Œæ™ºèƒ½ä½“åœ¨çŠ¶æ€$s$æ—¶é‡‡å–åŠ¨ä½œ$a$ä¹‹åèƒ½è·å¾—çš„å›æŠ¥çš„æœŸæœ›å€¼ã€‚
- `çŠ¶æ€ä»·å€¼å‡½æ•°V(s)`:åœ¨ç­–ç•¥$\pi$ä¸‹ï¼Œæ™ºèƒ½ä½“åœ¨å½“å‰çŠ¶æ€ä¸‹æ‰€èƒ½è·å¾—çš„æœŸæœ›å€¼ã€‚

ä¸¤ä¸ªä»·å€¼å‡½æ•°ä¹‹é—´å¯ä»¥ç›¸äº’è½¬æ¢ï¼Œè¿‘ä¼¼å…¬å¼ä¸ºï¼š

$$Q(a_t,s_t)\approx r+ \gamma V(s_{t+1})$$

- $\gamma$ï¼šæŠ˜æ‰£å› å­ï¼Œå–å€¼èŒƒå›´ä¸º$[0,1]$ï¼Œç”¨äºè¡¡é‡å³æ—¶å¥–åŠ±å’Œæœªæ¥å¥–åŠ±ä¹‹é—´çš„å…³è”åº¦

æ—©æœŸçš„`actor-criticæ¨¡å‹`ä¼˜åŒ–ç›®æ ‡å‡½æ•°ä½¿ç”¨çš„æ˜¯æ—©æœŸçš„ç­–ç•¥æ¢¯åº¦çš„è®¡ç®—ï¼Œå…¬å¼å¦‚ä¸‹ï¼š

$$\nabla_{ \theta} \mathbb{J}(\theta)=\mathbb{E}_{\tau \sim p(\tau; \theta)}[\sum_{t=0}^{T-1}\nabla_{\theta}log\pi_{\theta}(a_t|s_t)Q(s_t,a_t)]$$

<div style="background:#fff0dc;color:#000;padding:12px 16px;border-left:4px solid #ffb754;">
ä½†æ˜¯ä¸Šé¢çš„åšæ³•æœ‰ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ç”±åŠ¨ä½œä»·å€¼å‡½æ•°ä½œä¸ºå¥–åŠ±å‡½æ•°ï¼Œè®¡ç®—lossçš„æ—¶å€™æ–¹å·®ä¼šå¾ˆå¤§ï¼Œå› ä¸ºæ¨¡å‹çš„å‚æ•°æ›´æ–°æ°¸è¿œéƒ½æ˜¯æœç€æœ‰åˆ©äºæé«˜å¥–åŠ±çš„æ–¹å‘ï¼Œä»è€Œé™·å…¥å±€éƒ¨æœ€ä¼˜ï¼Œå¹¶ä¸”ä¹Ÿä¼šå¯¼è‡´å¾ˆå¤šæ ·æœ¬åˆ©ç”¨ç‡ä¸é«˜ã€‚</br>
è€Œä¸”ç­–ç•¥æ¨¡å‹çš„å‚æ•°ä¸å¥½æ›´æ–°ï¼Œå› ä¸ºåœ¨åŸå§‹åˆ†å¸ƒä¸­é‡‡æ ·å¾—åˆ°çš„ç»“æœæ–¹å·®ä¼šæ¯”è¾ƒå¤§ï¼Œå› æ­¤æƒ³è¦å¾—åˆ°ç¨³å®šçš„å‚æ•°æ›´æ–°é‡‡æ ·ä¼šå¾ˆå›°éš¾ã€‚</br>
ğŸ‘†PPOå°±è´Ÿè´£è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬çœ‹çœ‹PPOæ˜¯æ€ä¹ˆè§£å†³çš„ã€‚
</div>

**PPOåŸç†**

> å…¶å®å‡†ç¡®æ¥è¯´ï¼Œè§£å†³ä¸Šé¢é—®é¢˜çš„æ˜¯TRPOåšçš„ï¼Œä¸è¿‡PPOæ›´æœ‰åå¹¶ä¸”åº”ç”¨å¹¿æ³›ï¼Œè€Œä¸”PPOåªæ˜¯åœ¨TRPOçš„åŸºç¡€ä¸Šåšäº†ç‚¹ä¼˜åŒ–è®©æ–¹å·®æ›´å°ã€è®­ç»ƒæ›´ç¨³å®šï¼Œæ‰€ä»¥æˆ‘ä»¬ä»PPOè§’åº¦è®²èµ·ï¼Œåæ­£éƒ½æ˜¯openaiå›¢é˜Ÿçš„ã€‚

$$
J(\theta) = \mathbb{E}_{t} \left[ \min\left( \frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)} A^{\pi_{\theta_{\text{old}}}}(a_t|s_t), \text{clip}\left( \frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)}, 1-\epsilon, 1+\epsilon \right) A^{\pi_{\theta_{\text{old}}}}(a_t|s_t) \right) \right]
$$

ä¸Šé¢æ˜¯PPOï¼ˆå‡†ç¡®æ¥è¯´æ˜¯PPO-Clipï¼‰çš„ä¼˜åŒ–ç›®æ ‡å‡½æ•°ï¼Œç®€å•æ¥è¯´ï¼Œæœ‰ä¸‹é¢ä¸¤ä¸ªé‡è¦çš„ç‚¹ï¼š

1. ä¼˜åŠ¿å‡½æ•°ï¼š$A^{\pi_{\theta_{\text{old}}}}(a_t|s_t)$
2. é‡è¦æ€§é‡‡æ ·ï¼š$\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)}$

é¦–å…ˆå¯¹äºä¼˜åŠ¿å‡½æ•°ï¼š

$$A(s_t,a_t)=Q(s_t,a_t)-V(s_t)$$

æˆ‘ä»¬å°†$V(s_t)$å½“ä½œè¯¥çŠ¶æ€çš„åŸºçº¿å‡½æ•°ï¼Œå°†è¯¥çŠ¶æ€ä¸‹é€‰æ‹©æŸä¸€ä¸ªåŠ¨ä½œ$a_t$å¯¹åº”çš„ä»·å€¼å‡½æ•°å‡å»è¿™ä¸ªåŸºçº¿å‡½æ•°ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å‡å°‘ç­–ç•¥æ¢¯åº¦æ›´æ–°æ—¶çš„æ–¹å·®ï¼Œå¹¶ä¸”å¯ä»¥ä½¿å„ä¸ªåŠ¨ä½œçš„ç›¸å¯¹ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ï¼Œä»è€Œè®©æ¢¯åº¦æ›´æ–°å¯ä»¥é’ˆå¯¹æ€§çš„è°ƒæ•´æ‰§è¡ŒåŠ¨ä½œçš„æ¦‚ç‡ã€‚

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train23.png" style="width:90%">
  </figure>
</div>

å…¶æ¬¡å¯¹äºé‡è¦æ€§é‡‡æ ·ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ä¿®æ­£æ–°æ—§ç­–ç•¥ä¹‹é—´çš„åˆ†å¸ƒå·®å¼‚ï¼Œä»¥ä¾¿åˆ©ç”¨æ—§ç­–ç•¥é‡‡æ ·çš„æ•°æ®æ¥ä¼˜åŒ–æ–°ç­–ç•¥ï¼Œå…¶ä¸­$\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)}$ä¸é‡è¦æ€§é‡‡æ ·æœ‰å…³ï¼Œè¡¡é‡äº†æ–°æ—§ç­–ç•¥åœ¨åŒä¸€åŠ¨ä½œ$A^{\pi_{\theta_{\text{old}}}}(a_t|s_t)$ä¸Šçš„æ¦‚ç‡æ¯”å€¼ï¼š

- $\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)}>1$ï¼šæ–°ç­–ç•¥æ›´å€¾å‘äºé€‰æ‹©$A^{\pi_{\theta_{\text{old}}}}(a_t|s_t)$
- $\frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)}<1$ï¼šæ–°ç­–ç•¥å¯¹$A^{\pi_{\theta_{\text{old}}}}(a_t|s_t)$å€¾å‘å‡å¼±

> å…³äºæ›´è¯¦ç»†çš„é‡è¦æ€§é‡‡æ ·åŸç†ï¼Œå¯ä»¥å‚è€ƒ[è¿™ç¯‡](https://zhuanlan.zhihu.com/p/371156865)ã€‚

æœ€åä¸ºäº†é˜²æ­¢â€œè®­é£â€ï¼ŒåŠ äº†ä¸€ä¸ªè£å‰ªï¼Œå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„PPO-Clipï¼Œå¦å¤–ä¸€ä¸ªæ˜¯PPO-Penaltyæ˜¯åŠ KLæ•£åº¦çš„ï¼ŒåŸç†ä¸€æ ·ï¼Œä½†æ˜¯å› ä¸ºç®—æ³•è¡¨ç°ä¸å¦‚PPO-Clipï¼Œæ‰€ä»¥ä½¿ç”¨è¾ƒä¸ºæœ‰é™ã€‚

ä¸‹é¢æˆ‘ä»¬å†çœ‹çœ‹PPOçš„åŸç†å›¾ï¼Œå°±å¾ˆå¥½ç†è§£æ¯ä¸€ä¸ªæ¨¡å—æ˜¯ä¸ºäº†åšä»€ä¹ˆäº†ï¼š

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train24.png" style="width:90%">
  </figure>
</div>

å¥–åŠ±æ¨¡å‹(Reward Model)ç”¨äºè®¡ç®—æ¯ä¸ªåŠ¨ä½œå¯¹åº”çš„å¥–åŠ±ï¼Œè®­ç»ƒæ—¶å‚æ•°å›ºå®šã€‚ä»·å€¼æ¨¡å‹(Value Model)ç”¨äºè®¡ç®—æŸä¸ªçŠ¶æ€é€‰æ‹©æŸä¸ªåŠ¨ä½œåçš„å›æŠ¥æœŸæœ›ï¼Œéœ€è¦è·Ÿç€ç­–ç•¥æ¨¡å‹ä¸€èµ·è®­ç»ƒï¼Œå› ä¸ºéœ€è¦æ ¹æ®ç­–ç•¥æ¨¡å‹ç”Ÿæˆçš„å›ç­”å»ä¼°è®¡æœªæ¥å›æŠ¥ã€‚

ç„¶åå°†åŠ¨ä½œå¥–åŠ±å’Œå›æŠ¥æœŸæœ›åšGAEï¼Œå¾—åˆ°æœ€ç»ˆçš„ä¼˜åŠ¿ä¼°è®¡ã€‚

é‚£ä¹ˆGAEæ˜¯åšä»€ä¹ˆçš„ï¼Ÿä¸ºä»€ä¹ˆèƒ½ä¼°è®¡ä¼˜åŠ¿ï¼Ÿ

å¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://zhuanlan.zhihu.com/p/549145459)ï¼Œè¿™é‡Œç®€å•æè¿°ä¸‹ï¼š

ä»·å€¼å‡½æ•°çš„ä¼°è®¡åˆ†ä¸ºä¸¤ç§æ–¹æ³•ï¼š

1. `è’™ç‰¹å¡æ´›`ï¼šä¹Ÿå°±æ˜¯éµå¾ªç­–ç•¥$\pi$ï¼Œä»çŠ¶æ€$s_t$å‡ºå‘ï¼Œä¸€ç›´åˆ°æœ€ç»ˆçš„çŠ¶æ€ï¼Œå°†æ‰€æœ‰çš„å¥–åŠ±åŠ èµ·æ¥ï¼Œä½ å¤šå®éªŒå‡ æ¬¡ï¼Œç„¶åå°†å®éªŒåçš„ç»“æœå»å¹³å‡å€¼ï¼Œå°±èƒ½é€¼è¿‘çœŸå®çš„æœŸæœ›ã€‚
2. `è´å°”æ›¼(æ—¶åºå·®åˆ†)`ï¼šä¸éœ€è¦ç­‰å¾…å›åˆç»“æŸå°±å¯ä»¥ä¼°è®¡ä»·å€¼å‡½æ•°ï¼Œä¸­å¿ƒæ€æƒ³æ˜¯å°†å®Œæ•´çš„å¯¹æœªæ¥ä»·å€¼çš„é¢„ä¼°è½¬æ¢æˆå¤šä¸ªå­ä»»åŠ¡çš„å’Œï¼Œåœ¨è®¡ç®—ä»·å€¼å‡½æ•°çš„è¿‡ç¨‹ä¸­ï¼Œå°±æ˜¯å°†å®Œæ•´çš„ä»·å€¼å‡½æ•°->å½“å‰å¥–åŠ±+æœªæ¥å¥–åŠ±çš„æœŸæœ›ã€‚$V(s_t)\gets V(s_t)+\alpha(r_{t+1}+\gamma V(s_{t+1})-V(s_t))$æ›´æ–°ä»·å€¼å‡½æ•°ã€‚

å…¶ä¸­`è’™ç‰¹å¡æ´›`æ–¹æ³•åŠ¨ä½œéšæœºï¼Œæœ€åæ¯æ¬¡å®éªŒåçš„ä»·å€¼ä¼°è®¡åå·®å¤§ï¼Œæ–¹å·®æ¯”è¾ƒå°ï¼›è€Œ`æ—¶åºå·®åˆ†`çš„æ–¹æ³•ä¼šæœç€ä»·å€¼é«˜çš„æ–¹å‘é€‰æ‹©åŠ¨ä½œï¼Œæ¯æ¬¡å®éªŒåä»·å€¼ä¼°è®¡åå·®ä¼šæ¯”è¾ƒå°ï¼Œä½†æ˜¯æ–¹å·®æ¯”è¾ƒå¤§ã€‚

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train25.png" style="width:70%">
  </figure>
</div>

æç«¯çš„åå·®å’Œæ–¹å·®éƒ½ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæƒ³è¦ç¨³å®šçš„è®­ç»ƒå°±è¦åœ¨ä¸¤è€…ä¹‹é—´å–å¾—å¹³è¡¡ï¼ŒGAEï¼ˆGeneralized Advantage Estimationï¼Œå¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ï¼‰å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚

GAEå¼•å…¥è¡°å‡ç³»æ•° $\lambda$ï¼Œæƒè¡¡åå·®å’Œæ–¹å·®ï¼ˆ$\lambda$ è¶Šå°ï¼Œæ–¹å·®è¶Šå°ä½†åå·®è¶Šå¤§ï¼‰ï¼š
$$
\hat{A}_t^{(\lambda)} = \delta_t + \gamma \lambda \delta_{t+1} + \gamma^2 \lambda^2 \delta_{t+2} + \dots + \gamma^{T-t-1} \lambda^{T-t-1} \delta_{T-1}
$$

å› æ­¤æˆ‘ä»¬å°±èƒ½åœ¨ä¼°è®¡å‡ºä¼˜åŠ¿å‡½æ•°çš„åŒæ—¶ï¼Œåˆèƒ½åˆ©ç”¨ä¼˜åŠ¿å‡½æ•°æ¥ä¼˜åŒ–æ›´æ–°ç­–ç•¥å‡½æ•°çš„å‚æ•°ã€‚

**GRPOåŸç†**

ä¸Šé¢æˆ‘ä»¬å¯¹PPOçš„åŸç†æœ‰äº†æ¯”è¾ƒæ¸…æ™°çš„è®¤çŸ¥ï¼Œé‚£ä¹ˆGRPOå…·ä½“åšäº†ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬ç›´æ¥ä¸Š[è®ºæ–‡](https://arxiv.org/abs/2402.03300)é‡Œçš„å›¾ï¼š

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train26.png" style="width:90%">
  </figure>
</div>

æˆ‘ä»¬å†çœ‹ä¸‹å…¬å¼å¯¹æ¯”ï¼š

$J _{PPO}(\theta) = \mathbb{E}_{t} \left[ \min\left( \frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)} A^{\pi_{\theta_{\text{old}}}}(a_t|s_t), \text{clip}\left( \frac{\pi_\theta(a_t|s_t)}{\pi_{\theta_{\text{old}}}(a_t|s_t)}, 1-\epsilon, 1+\epsilon \right) A^{\pi_{\theta_{\text{old}}}}(a_t|s_t) \right) \right]$

$J _{GRPO}(\theta)=\mathbb{E} _t \left [\frac{1}{G}\sum_{i=1}^G\frac{1}{|o_i|}\sum_{t=1}^{|o_i|}\left( min\left [\frac{\pi _{\theta}(o_{i,t}|q,o_{i,<t})}{\pi_{\theta_{old}}(o_{i,t}|q,o_{i,<t})} \cdot \hat{A}_{i.t},clip(\frac{\pi_{\theta}(o_{i,t}|q,o_{i,<t})}{\pi_{\theta_{old}}(o_{i,t}|q,o_{i,<t})},1-\varepsilon,1+\varepsilon)\hat{A}_{i.t}]-\beta\mathbb{D}_{KL}[\pi_{\theta}||\pi_{ref}\right]\right)\right ]$

ç®€å•æ¥è¯´ä¿®æ”¹äº†ä¸¤å¤„åœ°æ–¹ï¼š

1. ä¼˜åŠ¿å‡½æ•°
2. å¢åŠ äº†KLæ•£åº¦

é¦–å…ˆæ˜¯ä¼˜åŠ¿å‡½æ•°ï¼Œæ˜¯æœ€å¤§çš„æ”¹åŠ¨ã€‚PPOçš„ä¼˜åŠ¿å‡½æ•°æˆ‘ä»¬çœ‹åˆ°ï¼Œåˆæ˜¯ä»·å€¼æ¨¡å‹ï¼Œåˆæ˜¯GAEä¼°è®¡ï¼Œä¸ä»…è®¡ç®—é‡å¤§ï¼Œè€Œä¸”ç”±äºå¤šäº†ä¸€ä¸ªæ¨¡å‹ï¼Œæ˜¾å­˜å ç”¨ä¹Ÿé«˜ï¼ŒåŒæ—¶clipä¹Ÿä¼šå¯¼è‡´æœ‰äº›æ ·æœ¬åˆ©ç”¨ç‡ä¸é«˜ï¼Œå®¹æ˜“é™·å…¥å±€éƒ¨æœ€ä¼˜ï¼Œå¹¶ä¸”å¦‚æœGAEå¹³è¡¡ä¸å¥½æ–¹å·®è¿˜æ˜¯ä¼šå¾ˆå¤§ï¼Œè®­ç»ƒä¸ç¨³å®šã€‚

GRPOï¼ˆGroup Relative Policy Optimizationï¼Œç¾¤ä½“ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–ï¼‰ä¼˜åŒ–äº†è¿™äº›é—®é¢˜ï¼ŒGRPOåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¯¹äºæ¯ä¸€ä¸ªé—®é¢˜qï¼Œæ—§çš„ç­–ç•¥ä¼šç”ŸæˆGä¸ªè¾“å‡º$\{o_1,o_2,...,o_G\}$ï¼Œéšåï¼Œé€šè¿‡ç»™äºˆè§„åˆ™çš„å¥–åŠ±æœºåˆ¶æˆ–è€…å¥–åŠ±å‡½æ•°å¯¹è¿™äº›è¾“å‡ºè¿›è¡Œæ‰“åˆ†ï¼Œå¾—åˆ°å¯¹åº”çš„å¤šä¸ªå¥–åŠ±å€¼$\{r_1,r_2,...,r_G\}$ï¼Œç„¶åç»è¿‡Group Computationè®¡ç®—å‡ºæ¯ä¸€ä¸ªå¥–åŠ±å¯¹åº”çš„ä¼˜åŠ¿å€¼$\{A_1,A_2,...,A_G\}$ã€‚

$\{A_1,A_2,...,A_G\}$è¿™ä¸€æ‰¹ä¼˜åŠ¿å€¼æˆ‘ä»¬ä¸å†åƒPPOä¸€æ ·åšçš„æ˜¯æœ‰åä¼°è®¡ï¼Œè€Œæ˜¯æ ¹æ®ä¸‹é¢çš„è®¡ç®—å¾—åˆ°æ— åä¼°è®¡å€¼ï¼š

$$A_i=\frac{r_i-mean(\{r_1,r_2,...,r_G\})}{std(\{r_1,r_2,...r_G\})}$$

ä¹Ÿå°±æ˜¯è¯´ä¼˜åŠ¿å‡½æ•°ä¸å†æ˜¯é€šè¿‡æ¨¡å‹ä¼°è®¡å‡ºæ¥çš„ï¼Œè€Œæ˜¯ç›´æ¥æ ¹æ®ç»“æœå¥–åŠ±è®¡ç®—å¾—åˆ°ä¼˜åŠ¿å€¼ï¼Œè‡ªç„¶GRPOå°±ä¸ç”¨ä»·å€¼æ¨¡å‹äº†ã€‚

ç„¶åå¢åŠ çš„KLæ•£åº¦æ˜¯é˜²æ­¢æ¨¡å‹â€œè®­é£â€çš„æ‰‹æ®µï¼ŒKLæ•£åº¦ä¸»è¦é€šè¿‡å¥–åŠ±å€¼è¿›è¡Œæƒ©ç½šæ¥æ¥å½±å“ä¼˜åŠ¿çš„è®¡ç®—ã€‚

<div style="background:#e7f8ff;color:#000;padding:12px 16px;border-left:4px solid #20c0ff;">
æˆ‘ä»¬æ€»ç»“ä¸‹ï¼ŒGRPOçš„æ ¸å¿ƒæ€æƒ³åœ¨äºåˆ©ç”¨ç¾¤ä½“ç›¸å¯¹ä¼˜åŠ¿ä¼°è®¡æ¥å–ä»£ä¼ ç»Ÿçš„ä»·å€¼æ¨¡å‹ï¼Œå…·ä½“æ¥è¯´ï¼ŒGRPOé€šè¿‡é‡‡æ ·ä¸€ç»„å€™é€‰è¾“å‡ºï¼Œå¹¶å°†è¿™äº›è¾“å‡ºçš„å¹³å‡å¥–åŠ±ä½œä¸ºåŸºçº¿ï¼Œæ¥è®¡ç®—æ¯ä¸ªè¾“å‡ºçš„ä¼˜åŠ¿å€¼ã€‚</br>
è¿™æ ·åšä¸ä»…é¿å…äº†å¯¹é¢å¤–çš„ä»·å€¼æ¨¡å‹çš„ä¾èµ–ï¼Œä¹Ÿå……åˆ†å‘æŒ¥äº†å¥–åŠ±æ¨¡å‹çš„æ¯”è¾ƒç‰¹æ€§ï¼Œä»è€Œæé«˜äº†è®­ç»ƒçš„æ•ˆç‡å’Œç¨³å®šæ€§ã€‚
</div>


# GPUè®­ç»ƒä»£ç 

## 1ã€ç¯å¢ƒé…ç½®

åŸºç¡€ç¯å¢ƒä½¿ç”¨2.8ç‰ˆæœ¬çš„pytorchï¼Œå› ä¸ºvllmæˆ‘ä»¬å®‰è£…äº†æœ€æ–°çš„0.11.0ç‰ˆæœ¬çš„ï¼Œå’Œ2.8ç‰ˆæœ¬çš„pytorché…å¥—ï¼Œå½“ç„¶å¦‚æœä½ç‰ˆæœ¬çš„ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œå°±æ˜¯å¯èƒ½è¿˜éœ€è¦å¸è½½å®‰è£…æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥å¹²è„†ä¸€æ¬¡æ€§å®‰è£…å¥½ã€‚

å®‰è£…å‘½ä»¤ï¼š

```bash
pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0
pip install -r requirements.txt
```

å¯¹ç¡¬ä»¶æ¡ä»¶çš„è¦æ±‚ï¼š

3Bæ¨¡å‹ï¼šæ™®é€šè®­ç»ƒ2å—5090ï¼Œvllmçš„è¯3å—ï¼ˆper_device_train_batch_size<=2ï¼‰
7Bæ¨¡å‹ï¼šæ™®é€šè®­ç»ƒ4å—5090ï¼Œvllmçš„è¯5å—ï¼ˆper_device_train_batch_size<=2ï¼‰

> å¦‚æœper_device_train_batch_sizeè¶…è¿‡2ï¼Œä¸Šé¢çš„èµ„æºæ’‘ä¸ä½ï¼Œéœ€è¦å†å¤šå‡ å—5090ã€‚
> å…¶ä»–GPUå…·ä½“æ²¡è¯•è¿‡ï¼Œå› ä¸ºæœ¬æ¬¡æ•™ç¨‹æˆ‘ä½¿ç”¨AutoDLä¸Šçš„ç®—åŠ›å®ç°çš„ï¼Œç”¨çš„æ›´å¤šè¿˜æ˜¯5090ã€‚
> é™¤äº†GPUï¼Œæ˜‡è…¾çš„910B2æˆ‘ä»¬ä¹Ÿè¿›è¡Œäº†å®éªŒï¼Œä¸‹é¢æˆ‘ä»¬è¡¥å……äº†ä¸‹NPUçš„ç¯å¢ƒé…ç½®ğŸ‘‡ï¼š

**NPUç¯å¢ƒå®‰è£…**

å‚è€ƒæ–‡çŒ®ï¼š[å®˜æ–¹æ–‡æ¡£](https://www.hiascend.com/document/detail/zh/Pytorch/600/configandinstg/instg/insg_0002.html)

å»ºè®®å‰ç½®å®‰è£…åŒ…
```bash
apt update  -y
apt install -y gcc g++ libnuma-dev
```

å»ºè®®å‰ç½®å®‰è£…å¦‚ä¸‹åŒ…

```bash
pip install attrs cython numpy==1.24.0 decorator sympy cffi pyyaml pathlib2 psutil protobuf==3.20 scipy requests absl-py ml-dtypes tornado cloudpickle jinja2
```

å¯èƒ½å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼Œæš‚æ—¶å¿½ç•¥

```bash
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
te 0.4.0 requires cloudpickle, which is not installed.
op-compile-tool 0.1.0 requires getopt, which is not installed.
op-compile-tool 0.1.0 requires inspect, which is not installed.
op-compile-tool 0.1.0 requires multiprocessing, which is not installed.
dataflow 0.0.1 requires jinja2, which is not installed.
```

å®‰è£…pytorch 2.4.0å’Œtorch_npu 6.0.0

```bash
# ä¸‹è½½PyTorchå®‰è£…åŒ…
wget https://download.pytorch.org/whl/cpu/torch-2.4.0-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
# ä¸‹è½½torch_npuæ’ä»¶åŒ…
wget https://gitee.com/ascend/pytorch/releases/download/v6.0.0-pytorch2.4.0/torch_npu-2.4.0.post2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
# å®‰è£…å‘½ä»¤
pip install torch-2.4.0-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
pip install torch_npu-2.4.0.post2-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
```

## 2ã€æ•°æ®é›†å¤„ç†

**æ•°æ®ç”Ÿæˆ**

å› ä¸º4\*4çš„æ•°ç‹¬è¦æ˜¯å®Œå…¨ç¬¦åˆè§„åˆ™ï¼Œæœ€ç»ˆä¹Ÿå°±åªæœ‰288ç§æƒ…å†µï¼Œè¿™æ ·çš„è§„æ¨¡æˆ‘ä»¬ä¸éœ€è¦çˆ¬å–æ•°æ®é›†ï¼Œç›´æ¥è‡ªå·±ç”Ÿæˆä¸€æ‰¹æ•°æ®ï¼Œä»£ç è¡¨ç¤ºåˆ†ä¸ºä¸¤æ­¥ï¼š

1. ç”Ÿæˆ288æ¡ç¬¦åˆè§„åˆ™çš„4\*4æ•°ç‹¬æ¸¸æˆç»“æœæ•°æ®
2. éšæœºæŒ–ç©ºè®¾ç½®question

æ•°æ®ç”Ÿæˆçš„ä»£ç å¯ä»¥å‚è€ƒğŸ‘‰[è¿™é‡Œ](https://github.com/828Tina/sudoku_trl_grpo/blob/main/datacreate.py)ï¼Œä¸‹é¢æˆ‘ä»¬è¡¥å……äº›ç»†èŠ‚ã€‚

1. é¦–å…ˆé‡‡ç”¨é€’å½’å¡«å……æ•°ç‹¬ç½‘ç»œçš„æ–¹å¼ç”Ÿæˆ10ä¸‡æ¡æ•°æ®ï¼Œç¡®ä¿éšæœºç”Ÿæˆçš„ç»“æœèƒ½è¦†ç›–æ‰€æœ‰çš„æƒ…å†µï¼Œå¹¶ä¸”æœ€ç»ˆåˆ é™¤æ‰é‡å¤æ•°æ®ï¼Œå°±èƒ½å¾—åˆ°288æ¡æ•°ç‹¬ç­”æ¡ˆçš„æ•°æ®ã€‚

2. ç„¶åæˆ‘ä»¬éœ€è¦å¯¹æ•°ç‹¬è®¾ç½®é—®é¢˜ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹ç­”æ¡ˆè¿›è¡ŒéšæœºæŒ–ç©ºä½œä¸ºé—®é¢˜ï¼Œå¹¶å°†æŒ–ç©ºçš„åœ°æ–¹ç”¨â€œ_â€æ›¿ä»£ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬è¦ç”Ÿæˆçš„æ•°æ®æ ·ä¾‹ï¼Œè™½ç„¶`question`éƒ¨åˆ†å¯èƒ½ä¸æ˜¯æ ‡å‡†åŒ–æ ¼å¼ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…è®­ç»ƒçš„æ—¶å€™ä¼šå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆè®­ç»ƒçš„æ—¶å€™ä¼šä»¥listæ ¼å¼ä½œä¸ºpromptçš„ä¸€éƒ¨åˆ†ã€‚

```json
{"question": "_24___1234212134", "answer": "1243431234212134", "label": "simple"}
```

æ¨¡å‹éœ€è¦æœ€ç»ˆå°†â€œ_â€æ›¿æ¢æˆç¬¦åˆæ•°ç‹¬æ¸¸æˆè§„åˆ™çš„æ•°å­—ï¼ŒåŒæ—¶å…¶ä»–æ²¡æœ‰è¢«æŒ–ç©ºçš„åœ°æ–¹ä¸è¦å˜åŠ¨ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡ã€‚

è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥æœ¬åœ°ç”Ÿæˆæ•°æ®é›†ï¼Œå…·ä½“å¯ä»¥ç”Ÿæˆä¸‹é¢çš„æ–‡ä»¶ğŸ‘‡ï¼š

```bash
python datacreate.py
```

```python
# ç”Ÿæˆçš„æ•°æ®
â”œâ”€â”€data
â”‚   â”œâ”€â”€ sudoku_4x4_answer.jsonl  # 288æ¡4*4åªæœ‰ç­”æ¡ˆçš„æ•°æ®é›†
â”‚   â””â”€â”€ sudoku_4x4_qa.jsonl      # éšæœºæŒ–ç©ºåçš„åŒ…å«é—®é¢˜å’Œç­”æ¡ˆçš„æ•°æ®é›†ï¼ˆè®­ç»ƒç”¨ï¼‰  
```

**æ•°æ®é¢„å¤„ç†**

è¯¥è¿‡ç¨‹åŒ…å«åœ¨è®­ç»ƒä»£ç ä¸­ï¼Œä¸»è¦ç”¨äºæ·»åŠ å‰ç¼€promptã€‚åœ¨å‰æ–‡æˆ‘ä»¬æåˆ°è¿‡ï¼Œå®é™…è®­ç»ƒçš„æ—¶å€™æˆ‘ä»¬éœ€è¦å°†æ•°ç‹¬æ¸¸æˆçš„é—®é¢˜ä»¥ç»“æ„åŒ–æ•°æ®å½¢å¼ä½œä¸ºé—®é¢˜çš„è¾“å…¥å’Œè¾“å‡ºï¼Œç»è¿‡æˆ‘ä»¬å®éªŒå‘ç°ä»¥Listå½¢å¼äº¤ç»™æ¨¡å‹æ•ˆæœæ¯”è¾ƒå¥½ï¼Œå…·ä½“æˆ‘ä»¬è¿˜æ˜¯åˆ†æˆä¸¤æ­¥å®ç°ï¼š

1. å°†`question`æ¯ä¸ªæ•°å­—åˆ†éš”å¼€ä¿å­˜åˆ°Listä¸­
2. è®¾è®¡è®­ç»ƒç”¨çš„å‰ç¼€æç¤ºè¯ï¼Œç¡®ä¿æ¨¡å‹èƒ½å¤Ÿéµå¾ªæŒ‡ä»¤å®Œæˆæ•°ç‹¬æ¸¸æˆçš„æ¨ç†ä»»åŠ¡

```python
## å°†`question`æ¯ä¸ªæ•°å­—åˆ†éš”å¼€ä¿å­˜åˆ°Listä¸­
SUDOKU_FORMAT = "[[{},{},{},{}],\n[{},{},{},{}],\n[{},{},{},{}],\n[{},{},{},{}]]"
sudo_str = SUDOKU_FORMAT.format(*[c for c in example["question"]])
# '[[_,2,4,_],\n[_,_,1,2],\n[3,4,2,1],\n[2,1,3,4]]'

## è®¾è®¡è®­ç»ƒç”¨çš„å‰ç¼€æç¤ºè¯ï¼Œç¡®ä¿æ¨¡å‹èƒ½å¤Ÿéµå¾ªæŒ‡ä»¤å®Œæˆæ•°ç‹¬æ¸¸æˆçš„æ¨ç†ä»»åŠ¡
PROMPT_TEMPLATE = """è¯·ä½œä¸ºæ•°ç‹¬ä¸“å®¶å®Œæˆ4x4æ•°ç‹¬é¢˜ç›®ã€‚æ•°ç‹¬é¢˜ç›®ä¸­å·²ç»™å‡ºæ•°å­—ä¸ºé™å®šæ¡ä»¶ï¼Œâ€œ_â€è¡¨ç¤ºå¾…å¡«å…¥1-4çš„ç©ºç™½ä½ç½®ã€‚
## æ•°ç‹¬è§„åˆ™
- æ ¹æ®æ•°ç‹¬çŸ©é˜µä¸­å·²ç»™å‡ºçš„æ•°å­—æ¨æµ‹â€œ_â€å¤„çš„æ•°å­—
- æ¯è¡Œï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡
- æ¯åˆ—ï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡  
- æ¯ä¸ª2Ã—2å®«æ ¼ï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡
## è§£é¢˜æµç¨‹
1. é€‰æ‹©ä¸€å¤„ç©ºç™½ä½ç½®â€œ_â€ï¼ŒæŒ‰è¡Œã€åˆ—ã€å®«æ ¼åˆ†æåº”è¯¥å¡«å…¥çš„æ•°å­—
2. æ‰“å°å¡«è¡¥ä¸€å¤„ç©ºç™½çš„çŸ©é˜µï¼Œåˆ¤æ–­è¯¥æ¬¡å¡«å……æ˜¯å¦æ­£ç¡®
3. é‡å¤æµç¨‹1ï¼Œç›´è‡³æ‰€æœ‰ç©ºç™½ä½ç½®â€œ_â€è¢«å¡«å®Œã€‚
## è¾“å‡ºæ ¼å¼
è¾“å‡ºæ ¼å¼ä¸º<think>...</think>\n<answer>...</answer>
åœ¨<think>...</think>ä¸­å¡«å…¥æ€è€ƒè¿‡ç¨‹
åœ¨<answer>...</answer>ä¸­å¡«å†™python Listæ ¼å¼çš„æœ€ç»ˆçŸ©é˜µ
è¾“å‡ºæ ¼å¼æ¡ˆä¾‹ï¼š
<think>
è¯¦ç»†æ¨ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- ä¸€æ­¥æ­¥çš„æ€è€ƒè¿‡ç¨‹
- å¯¹é¢˜ç›®çš„å¤è¿°ï¼Œä»¥åŠè¦åˆ†æçš„ç©ºç™½ä½ç½®
- å¡«å…¥ç©ºç™½ä½ç½®çš„æ•°å­—ä»¥åŠç†ç”±ï¼ŒæŒ‰è¡Œã€åˆ—ã€å®«æ ¼è§„åˆ™åˆ†æ
- æ£€æŸ¥å¡«å…¥åçš„æ•°ç‹¬çŸ©é˜µï¼Œç¡®ä¿ç¬¦åˆæ•°ç‹¬è§„åˆ™ï¼Œç¡®ä¿æ²¡æœ‰ä¿®æ”¹é¢˜ç›®é™å®šæ¡ä»¶
</think>
<answer>[[1,2,3,4],[4,3,...],...]</answer>
## æ•°ç‹¬é¢˜ç›®ï¼š
{}"""
user_prompt = PROMPT_TEMPLATE.format(sudo_str)
messages = {
            "prompt": [
                {"role": "user", "content": user_prompt},
            ],
            "answer": [int(c) for c in example["answer"]],
          }
```

<div style="background:#fff0dc;color:#000;padding:12px 16px;border-left:4px solid #ffb754;">
è¿™å¥—æç¤ºè¯æˆ‘ä»¬è®¾è®¡äº†å¾ˆå¤šç‰ˆï¼Œå› ä¸ºè¿™ä¸ªæç¤ºè¯æ˜¯ä½œä¸ºGRPOè®­ç»ƒæ—¶è®©æ¨¡å‹ç”Ÿæˆå›ç­”çš„ï¼Œ<strong>å› æ­¤éœ€è¦æä¾›å‡†ç¡®çš„è§„åˆ™æè¿°å’Œè¶³å¤Ÿçš„çº¦æŸæ¡ä»¶</strong>ã€‚</br><strong>åŒæ—¶ä¹Ÿéœ€è¦æ³¨æ„ï¼Œæç¤ºè¯ä¸èƒ½è¿‡é•¿ã€‚</strong>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Qwen2.5çš„instructæ¨¡å‹ï¼Œè¯¥æ¨¡å‹åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœæç¤ºè¯å†…å®¹è¿‡é•¿ï¼Œä¹Ÿå°±æ˜¯ç»™çš„æ¡ä»¶è¿‡äºå¤æ‚ï¼Œä¼šå¤§å¤§å‰Šå‡å…¶GRPOè®­ç»ƒçš„æ•ˆæœã€‚</br>
ğŸ’¡æˆ‘ä»¬æ€»ç»“ä¸‹ï¼š</br>
1. æç¤ºè¯æ¨¡æ¿éœ€è¦æä¾›å‡†ç¡®çš„è§„åˆ™æè¿°å’Œè¶³å¤Ÿçš„çº¦æŸæ¡ä»¶</br>
2. æç¤ºè¯æ¨¡æ¿ä¸èƒ½è¿‡äºå¤æ‚ï¼Œå°½é‡ç²¾ç®€
</div>

## 3ã€è®­ç»ƒä»£ç 

æˆ‘ä»¬ä½¿ç”¨trlæ¡†æ¶æ¥åšGRPOçš„å¼ºåŒ–å­¦ä¹ è®­ç»ƒä»»åŠ¡ï¼Œæˆ‘ä»¬çš„ä»£ç é“¾æ¥ğŸ‘‰[åœ¨è¿™](https://github.com/828Tina/sudoku_trl_grpo)ã€‚

TRL (Transformers Reinforcement Learningï¼Œç”¨å¼ºåŒ–å­¦ä¹ è®­ç»ƒTransformersæ¨¡å‹) æ˜¯ä¸€ä¸ªé¢†å…ˆçš„Pythonåº“ï¼Œæ—¨åœ¨é€šè¿‡ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰ã€è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–ï¼ˆPPOï¼‰å’Œç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰ç­‰å…ˆè¿›æŠ€æœ¯ï¼Œå¯¹åŸºç¡€æ¨¡å‹è¿›è¡Œè®­ç»ƒåä¼˜åŒ–ã€‚TRLå»ºç«‹åœ¨ğŸ¤—Huggingface Transformersç”Ÿæ€ç³»ç»Ÿä¹‹ä¸Šï¼Œæ”¯æŒå¤šç§æ¨¡å‹æ¶æ„å’Œæ¨¡æ€ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨å„ç§ç¡¬ä»¶é…ç½®ä¸Šè¿›è¡Œæ‰©å±•ã€‚

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train3.png" style="width:100%">
  </figure>
</div>

trlæä¾›äº†æ–¹ä¾¿çš„GRPOè®­ç»ƒå™¨æ¡†æ¶`GRPOTrainer`ï¼Œæˆ‘ä»¬åªéœ€è¦å›´ç»•`GRPOTrainer`æ³¨æ„è¾“å…¥çš„å‚æ•°çš„æ ¼å¼å³å¯ã€‚**å…¶ä¸­æœ€éš¾çš„åœ°æ–¹åœ¨äºå¥–åŠ±å‡½æ•°çš„è®¾è®¡è€Œä¸æ˜¯ä»£ç æœ¬èº«ï¼Œåˆç†çš„å¥–åŠ±å‡½æ•°æœ‰åŠ©äºæå‡è®­ç»ƒçš„å‡†ç¡®åº¦ã€‚** ä¸‹é¢æˆ‘ä»¬é’ˆå¯¹ä¸åŒçš„éƒ¨åˆ†è¯¦ç»†è®²è¿°ä»£ç åŸç†ï¼Œå¸®åŠ©è¯»è€…æ›´è½»æ¾çš„ç†Ÿæ‚‰trlæ¡†æ¶å¹¶è½»æ¾è®­ç»ƒGRPOã€‚

```python
# æˆ‘ä»¬çš„GRPOTrainerè®¾ç½®
trainer = GRPOTrainer(
        model=model_args.model_name_or_path,  # æ¨¡å‹åç§°æˆ–è·¯å¾„
        # å¥–åŠ±å‡½æ•°åˆ—è¡¨ï¼Œç”¨äºè®¡ç®—å¥–åŠ±åˆ†æ•°
        reward_funcs=[
            # 1. æ ¼å¼å¥–åŠ±å‡½æ•°
            format_reward_func,
            # 2. é•¿åº¦å¥–åŠ±å‡½æ•°
            len_reward_func,
            # 3. é—®é¢˜ä¿æŒå¥–åŠ±å‡½æ•°
            question_match_reward,
            # 4. è§„åˆ™éµå®ˆå¥–åŠ±å‡½æ•°
            ans_row_reward,
            ans_col_reward,
            ans_block_reward,
        ],
        args=training_args,
        train_dataset=train_dataset,
        eval_dataset=eval_dataset,
        peft_config=get_peft_config(model_args),
    )
```

**å¥–åŠ±å‡½æ•°è®¾è®¡**

æˆ‘ä»¬è®¾è®¡äº†å¾ˆå¤šçš„å¥–åŠ±å‡½æ•°ï¼Œä½†æ˜¯æ•´ä½“ä¸Šæˆ‘ä»¬åˆ†æˆä¸‹é¢å››ä¸ªæ¨¡å—ï¼š

1. æ ¼å¼å¥–åŠ±å‡½æ•°
2. é•¿åº¦å¥–åŠ±å‡½æ•°
3. é—®é¢˜ä¿æŒå¥–åŠ±å‡½æ•°
4. è§„åˆ™éµå®ˆå¥–åŠ±å‡½æ•°

<div style="background:#e7f8ff;color:#000;padding:12px 16px;border-left:4px solid #20c0ff;">
æˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½®è§£ç­”å¥–åŠ±å‡½æ•°ï¼ŒåŸå› æˆ‘ä»¬åœ¨å‰æ–‡ä»‹ç»å¥–åŠ±å‡½æ•°è®¾è®¡çš„éš¾ç‚¹å¤„æåˆ°è¿‡ï¼Œå¯¹äºæ•°ç‹¬æ¸¸æˆæ¥è¯´ï¼Œå³ä¾¿é¢˜ç›®ä¸€è‡´ï¼Œæœ‰å¯èƒ½å›ç­”æœ‰å¤šç§å¯èƒ½ï¼ˆæˆ‘ä»¬åœ¨å®é™…è®­ç»ƒçš„æ—¶å€™æŒ–çš„ç©ºæ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥å‡ºç°å¤šç§ç­”æ¡ˆçš„å¯èƒ½æ€§ä¸å¤§ï¼Œä½†æ˜¯ä»ç„¶ä½¿ç”¨è§„åˆ™å¥–åŠ±å‡½æ•°ï¼Œå› ä¸ºè¿™ä¸ªå¥–åŠ±å‡½æ•°å¯ä»¥é€šç”¨åŒæ—¶åŸç†ä¸€è‡´ï¼‰
</div>

æˆ‘ä»¬ä¾æ¬¡è¯¦ç»†è§£é‡Šå…¶åŸç†ï¼š

**1. æ ¼å¼å¥–åŠ±å‡½æ•°**

ç”±äºæ•°ç‹¬æ¸¸æˆçš„ç‰¹æ®Šæ€§ï¼Œé™¤äº†åŸºç¡€çš„special tokenï¼š\<think>\</think>ã€\<answer>\</answer>éœ€è¦éµå®ˆå¤–ï¼Œè¿˜éœ€è¦æ ¹æ®ä¸‹é¢çš„è¦æ±‚è®¾è®¡å¥–åŠ±å‡½æ•°ï¼š

- 4\*4çš„æ¯ä¸ªç©ºåªèƒ½å¡«å†™[1,2,3,4]ä¸­çš„æ•°ï¼Œä¸€æ—¦æœ‰å…¶ä»–çš„æ•°å­—æ¯”å¦‚5ï¼Œ6ç­‰å°±ç®—é”™è¯¯
- 4\*4çš„æ•°ç‹¬æ¸¸æˆæ€»å…±ä¹Ÿåªæœ‰16ä¸ªä½ç½®ï¼Œæ¨¡å‹åœ¨ç”Ÿæˆçš„æ—¶å€™é™¤äº†ä¼šè‡ªå·±æ”¹é¢˜ï¼Œè¿˜å¯èƒ½æ“…è‡ªä¿®æ”¹é¢˜ç›®è®¾å®šï¼Œæˆ‘ä»¬åœ¨å®éªŒçš„æ—¶å€™å‘ç°æœ¬æ¥4\*4çš„çŸ©é˜µï¼Œèƒ½ç”Ÿæˆ5\*4ï¼Œä¹Ÿå°±æ˜¯å¤šä¸€è¡Œæˆ–è€…å¤šè¡Œçš„æƒ…å†µï¼Œå› æ­¤å¦‚æœæ¨¡å‹ç”Ÿæˆçš„ç»“æœè¶…è¿‡16ä¸ªï¼Œä¹ŸæŒ‰ç…§æ ¼å¼é”™è¯¯æ¥ç®—

> æ»¡åˆ†æˆ‘ä»¬æŒ‰ç…§0.6åˆ†æ¥ç®—ï¼Œè¿™åªæ˜¯ä¸ºäº†å’Œé•¿åº¦å¥–åŠ±å‡½æ•°å‡‘å¤Ÿå’Œä¸º1

```python
## æ ¼å¼å‡†ç¡®å¥–åŠ±
def format_reward_func(completions, prompts, **kwargs):
    """Reward function that checks if the completion has a specific format."""
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                # åˆ¤æ–­æ•°å­—æ˜¯16ä¸ªï¼Œä¸”éƒ½åœ¨1-4
                if len(number) == 16 and all(0 < x < 5 for x in number):
                    rewards.append(1.0)
                else:
                    rewards.append(0.0)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.6 for r in rewards]
    return rewards
```

**2. é•¿åº¦å¥–åŠ±å‡½æ•°**

å› ä¸ºæˆ‘ä»¬çš„èµ„æºæœ‰é™ï¼Œå¯¹äºç”Ÿæˆçš„é•¿åº¦æˆ‘ä»¬éœ€è¦åŠ ä»¥é™åˆ¶ï¼Œæˆ‘ä»¬é¢„è®¡`prompt+completions=2048`çš„é•¿åº¦ï¼Œå› ä¸ºpromptæˆ‘ä»¬è®¾è®¡çš„æç¤ºè¯å¾ˆçŸ­ï¼Œæ‰€ä»¥`max_prompt_length=400`ï¼Œæœ€å¤§çš„ç”Ÿæˆé•¿åº¦`max_completion_length=1648`ï¼Œè¶Šæ¥è¿‘æœ€å¤§ç”Ÿæˆé•¿åº¦æ‰£åˆ†è¶Šå¤šï¼Œç¡®ä¿æ€è€ƒé•¿åº¦ä¸ä¼šå¤ªé•¿ã€‚

æ€»åˆ†è®¾ç½®ä¸º0.4ï¼Œå’Œå‰é¢çš„æ ¼å¼å¥–åŠ±æŒ‰ç…§æƒé‡æ¯”ä¾‹ç»¼åˆä¸º1

```python
## é•¿åº¦å¥–åŠ±
def len_reward_func(completions, **kwargs):
    """Reward function for response len."""
    content_len = [len(completion[0]["content"]) for completion in completions]
    rewards = []
    for clen in content_len:
        if clen < 1648 - 64:  # 2048-400=1648
            rewards.append(1.0)
        else:
            rw = (1648 - clen) / 64
            rewards.append(rw if rw >= 0 else 0.0)
    rewards = [r * 0.4 for r in rewards]
    return rewards
```

**3. é—®é¢˜ä¿æŒå¥–åŠ±å‡½æ•°**

è‡ªå›å½’æ¨¡å‹æ˜¯æ ¹æ®å‰æ–‡é¢„æµ‹åæ–‡ï¼Œæˆ‘ä»¬åœ¨promptä¸­è™½ç„¶è¦æ±‚æ¨¡å‹å¡«å……ç©ºç™½ä½ç½®â€œ_â€ï¼Œä½†æ˜¯æœ€ç»ˆè¾“å‡ºå®Œæ•´çš„æ•°ç‹¬ç»“æœï¼Œè‡ªç„¶åŒ…æ‹¬æ²¡è¢«æŒ–å»çš„éƒ¨åˆ†ã€‚å› ä¸ºæˆ‘ä»¬å¯¹äºè§£ç­”çš„å‡†ç¡®åº¦å¥–åŠ±å‡½æ•°æ˜¯æ ¹æ®è§„åˆ™çœ‹æ˜¯å¦ç¬¦åˆè§„åˆ™ï¼Œå¹¶æ²¡æœ‰æ˜ç¡®çš„å¯¹ç­”æ¡ˆï¼Œå› æ­¤æ¨¡å‹å¯èƒ½ä¼šâ€œè€å°èªæ˜â€ï¼Œåªè¦ç¬¦åˆè¡Œã€åˆ—ã€å®«æ ¼çš„è§„åˆ™å°±èƒ½å¾—åˆ°rewardï¼Œé‚£ä¹ˆæ”¹é¢˜ä¹Ÿå¯ä»¥å®ç°è¿™ä¸€è¦æ±‚ï¼Œå¦‚æœä¸å¯¹è¾“å…¥çš„é—®é¢˜è®¾è®¡å¥–åŠ±å‡½æ•°ï¼Œé‚£ä¹ˆæ¨¡å‹å¯èƒ½ä¼šå˜æˆåªä¼šéµå®ˆè§„åˆ™è€Œä¸åœ¨ä¹è¾“å…¥é—®é¢˜ã€‚

å¯¹äºé—®é¢˜ä¿æŒçš„å¥–åŠ±å‡½æ•°ï¼Œæˆ‘ä»¬æŒ‰ç…§é—®é¢˜ä¿æŒçš„æ•°å­—çš„ä¸ªæ•°æ¥è®¡ç®—ï¼Œå’ŒåŸ`question`å¯¹åº”ï¼Œé”™ä¸€ä¸ªæ‰£ä¸€ç‚¹åˆ†ï¼Œæ»¡åˆ†ä¸º1åˆ†ã€‚

```python
## é—®é¢˜æè¿°å‡†ç¡®å¥–åŠ±
def question_match_reward(completions, question, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match, qs_str in zip(matches, question):
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                question_match_num = sum(
                    1 for a, b in zip(numberstr, qs_str) if b != "_" and a == b
                )
                question_match_rate = question_match_num / (16 - qs_str.count("_"))
                rewards.append(question_match_rate)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 1.0 for r in rewards]
    return rewards
```

**4. è§„åˆ™éµå®ˆå¥–åŠ±å‡½æ•°**

å¯¹äºæ•°ç‹¬æ¸¸æˆï¼Œå¦‚æœæŒ–çš„ç©ºè¿‡å¤šï¼Œå¯èƒ½ç­”æ¡ˆä¸æ­¢ä¸€ç§ï¼Œå› æ­¤æŒ‰ç…§ç­”æ¡ˆæ¥è®¾è®¡ç­”æ¡ˆå¥–åŠ±å‡½æ•°å¹¶ä¸åˆç†ï¼Œè™½ç„¶æˆ‘ä»¬çš„å®éªŒåªæŒ–4ä¸ªç©ºï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶æŒ‰ç…§æ˜¯å¦éµå®ˆè§„åˆ™æ¥è®¾è®¡å¥–åŠ±å‡½æ•°ï¼Œå³æ¯è¡Œã€æ¯åˆ—ã€æ¯ä¸€ä¸ª2\*2çš„å°å®«æ ¼æ˜¯å¦æ˜¯1-4ä¸­çš„æ•°å­—ï¼Œå¹¶ä¸”æ¯ä¸ªæ•°å­—å‡ºç°éƒ½ä¸é‡å¤ï¼Œæ¯é”™è¯¯ä¸€ä¸ªæ‰£ä¸€äº›åˆ†æ•°ï¼Œè¡Œå¥–åŠ±å‡½æ•°æ»¡åˆ†ä¸º0.4ï¼Œåˆ—å’Œå®«å¥–åŠ±å‡½æ•°æ»¡åˆ†éƒ½ä¸º0.3ã€‚

<div style="background:#e7f8ff;color:#000;padding:12px 16px;border-left:4px solid #20c0ff;">
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½é‡é¿å…â€œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«â€çš„æƒ³æ³•è®¾è®¡å¥–åŠ±å‡½æ•°ï¼Œå³ä½†å‡¡æœ‰ä¸€ä¸ªæ•°å­—ä¸å¯¹ï¼Œç›´æ¥reward=0ï¼Œæœ¬èº«æ•°ç‹¬æ¸¸æˆå’Œæ™®é€šçš„æ•°å­¦é—®é¢˜ä¸åŒï¼Œæ•´ä½“çš„ç­”æ¡ˆéƒ½ä¸ä¸€å®šåªæœ‰ä¸€ç§ï¼Œæ›´ä½•å†µéœ€è¦å¡«å†™çš„æ•°å­—æ•°é‡ä¸ä¸º1ï¼Œéœ€è¦å¡«å……å¤šä¸ªæ•°å­—ï¼Œå¦‚æœä»…ä¸€å¤„é”™è¯¯å°±å°†å¥–åŠ±è®¾ç½®ä¸º0ï¼Œé‚£ä¹ˆè®­ç»ƒçš„â€œé¡¿æ‚Ÿâ€æ—¶åˆ»å¾ˆéš¾æ¥ä¸´ï¼Œå› ä¸ºè¿™è·Ÿæ¨¡å‹è‡ªèº«çš„èƒ½åŠ›æœ‰å…³ã€‚7Bçš„æ¨¡å‹è¿˜å¥½ï¼Œ3Bçš„æ¨¡å‹åœ¨è®­ç»ƒå‰åšç®€å•çš„æ¨ç†ï¼Œç»“æœæ­£ç¡®çš„æƒ…å†µæå°‘ï¼Œå¦‚æœå¯¹äºrewardè®¾ç½®çš„è¿‡äºä¸¥è‹›ï¼Œå¯¹äº3Bè¿™ç§è§„æ¨¡çš„æ¨¡å‹å¾ˆéš¾å­¦åˆ°æ­£ç¡®çš„è§£ç­”æ–¹å¼ã€‚
</div>

```python
## æ•°ç‹¬è¡Œå‡†ç¡®è¯„ä¼°
def ans_row_reward(completions, answer, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                if len(number) != 16:
                    rewards.append(0.0)
                else:
                    matrix_4x4 = np.array(number).reshape(4, 4)
                    reward = [len(np.unique(row)) / 4 for row in matrix_4x4]
                    rewards.append(sum(reward) / 4)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.4 for r in rewards]
    return rewards

## æ•°ç‹¬åˆ—å‡†ç¡®è¯„ä¼°
def ans_col_reward(completions, answer, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                if len(number) != 16:
                    rewards.append(0.0)
                else:
                    matrix_4x4 = np.array(number).reshape(4, 4)
                    matrix_4x4 = matrix_4x4.T
                    reward = [len(np.unique(row)) / 4 for row in matrix_4x4]
                    rewards.append(sum(reward) / 4)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.3 for r in rewards]
    return rewards

## æ•°ç‹¬å—å‡†ç¡®è¯„ä¼°
def ans_block_reward(completions, answer, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                if len(number) != 16:
                    rewards.append(0.0)
                else:
                    matrix_4x4 = np.array(number).reshape(4, 4)
                    reward = 0
                    reward += len(np.unique(matrix_4x4[0:2, 0:2])) / 4
                    reward += len(np.unique(matrix_4x4[0:2, 2:4])) / 4
                    reward += len(np.unique(matrix_4x4[2:4, 0:2])) / 4
                    reward += len(np.unique(matrix_4x4[2:4, 2:4])) / 4
                    rewards.append(reward / 4)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.3 for r in rewards]
    return rewards

```

**LoRAå‚æ•°è®¾ç½®**

å› ä¸ºå¯¹äºå¼ºåŒ–å­¦ä¹ ä»»åŠ¡ï¼Œå“ªæ€•GRPOä¼˜åŒ–äº†PPOå°‘äº†Criticæ¨¡å‹å‚ä¸è®­ç»ƒï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦æ¨¡å‹å‰å‘ä¼ æ’­ç”Ÿæˆå¤šä¸ªå›ç­”è¿›è¡Œé‡‡æ ·ï¼ŒåŒæ—¶è¿˜åŒ…å«æ­£å¸¸è®­ç»ƒä»»åŠ¡æ¯”å¦‚åå‘ä¼ æ’­ç­‰å¯¹äºæ˜¾å­˜çš„å ç”¨ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å…¨å‚é‡å¾®è°ƒçš„æ–¹å¼ï¼Œå¯¹äºèµ„æºè¦æ±‚å¾ˆé«˜ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰é‚£ä¹ˆå¤šçš„èµ„æºï¼Œå†µä¸”å› ä¸ºæˆ‘ä»¬å®Œæˆçš„æ˜¯ç®€å•çš„æ•°ç‹¬æ¸¸æˆä»»åŠ¡ï¼Œ4\*4çš„å¤§å°æœ€å¤šå°±16ä¸ªæ•°å­—ï¼Œå¯¹äº3Bæ¨¡å‹æ¥è¯´è¿˜æœ‰ç‚¹åƒåŠ›ï¼Œä½†æ˜¯å¯¹äº7Bæ¨¡å‹ä»»åŠ¡å°±æ¯”è¾ƒç®€å•äº†ï¼Œç”¨LoRAå’Œå…¨å‚çš„å·®åˆ«ä¸å¤§ï¼Œæˆ‘ä»¬ä½¿ç”¨LoRAå¾®è°ƒçš„æ–¹å¼æ¥è¿›è¡ŒGRPOçš„è®­ç»ƒã€‚

ä¸è¿‡åœ¨å®é™…ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œæˆ‘å‘ç°trlå¯¹äºè¾“å…¥çš„`model`å¹¶ä¸æ˜¯æˆ‘ä»¥ä¸ºçš„`model_name_or_path`ï¼Œå¯ä»¥ç”¨`AutoModelForCausalLM`æ¥åŠ è½½å¥½æ¨¡å‹åï¼Œç»“åˆ`loraconfig`ä½¿ç”¨`peft`åº“çš„`get_peft_model`ä½œä¸º`GRPOtrainer`çš„è¾“å…¥æ¥å®ç°loraè®­ç»ƒï¼Œä¹Ÿå°±æ˜¯**ä¸‹é¢è¡¨ç¤ºçš„ä¼ªä»£ç æ˜¯âŒçš„ï¼š**

```python
from transformers import AutoModelForCausalLM, AutoTokenizer
from peft import get_peft_model,LoraConfig

lora_config=LoraConfig(
    ...
)
model=AutoModelForCausalLM.from_pretrained(
    ...
)
model=get_peft_model(model, lora_config)
trainer = GRPOTrainer(
        model=model
        ...
)
```

äº‹å®ä¸Šï¼Œtrlåœ¨GRPOTraineré‡Œå·²ç»åŠ å…¥äº†loraå‚æ•°çš„é…ç½®ï¼Œæˆ‘ä»¬åœ¨å®˜æ–¹ä»£ç é‡Œæ‰¾åˆ°[å¯¹åº”ä½ç½®](https://github.com/huggingface/trl/blob/main/trl/trainer/grpo_trainer.py#L218)ï¼Œå¦‚æœéœ€è¦LoRAæˆ–è€…å…¶ä»–éƒ¨åˆ†å‚æ•°è®­ç»ƒçš„æ–¹æ³•ï¼Œå¯ä»¥å°†æ¨¡å‹å‚æ•°å’Œloraå‚æ•°å¯¼å…¥åˆ°`peft_config`ä¸­ï¼Œä¸‹é¢è¡¨ç¤ºçš„ä¼ªä»£ç æ‰æ˜¯å¯ä»¥ç”¨çš„âœ…

```python
trainer = GRPOTrainer(
        model=model_args.model_name_or_path,
        ...
        peft_config=get_peft_model(model_args)
)
```

**å®Œæ•´è®­ç»ƒä»£ç **

å®˜æ–¹å…¶å®ç»™äº†ç›¸åº”çš„è®­ç»ƒè„šæœ¬ï¼ŒGRPOè®­ç»ƒçš„ä»£ç å¯ä»¥å‚è€ƒå®˜æ–¹çš„[ä»£ç ](https://github.com/huggingface/trl/blob/main/trl/scripts/grpo.py)ã€‚

é’ˆå¯¹æˆ‘ä»¬çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ä¹Ÿç»™å‡ºäº†æˆ‘ä»¬çš„è®­ç»ƒä»£ç ï¼Œæˆ‘ä»¬å·²å°†ä»£ç å¼€æºï¼Œåœ°å€åœ¨ğŸ‘‰[è¿™é‡Œ](https://github.com/828Tina/sudoku_trl_grpo)ã€‚åªè¦åœ¨ä»£ç ä¸­åŒ…å«ä¸‹é¢çš„å†…å®¹å°±è¡Œï¼š

1. å¥–åŠ±å‡½æ•°
2. æ•°æ®é¢„å¤„ç†
3. å‚æ•°é…ç½®

```python
import os
import re
from dataclasses import dataclass

import datasets
from trl import ModelConfig, GRPOConfig, GRPOTrainer, TrlParser, get_peft_config

import swanlab
import numpy as np

################################################
# è‡ªå®šä¹‰å‚æ•°ç±»
################################################
rl_setting = swanlab.Settings(max_log_length=4096)
swanlab.merge_settings(rl_setting)


################################################
# è‡ªå®šä¹‰å‚æ•°ç±»
################################################
@dataclass
class DatasetArguments:
    """æ•°æ®é›†å‚æ•°çš„æ•°æ®ç±»"""

    dataset_id_or_path: str = "json"
    data_files: str = "./data/sudoku_4x4_qa_nostar.jsonl"


################################################
# æç¤ºè¯æ ¼å¼
################################################
PROMPT_TEMPLATE = """è¯·ä½œä¸ºæ•°ç‹¬ä¸“å®¶å®Œæˆ4x4æ•°ç‹¬é¢˜ç›®ã€‚æ•°ç‹¬é¢˜ç›®ä¸­å·²ç»™å‡ºæ•°å­—ä¸ºé™å®šæ¡ä»¶ï¼Œâ€œ_â€è¡¨ç¤ºå¾…å¡«å…¥1-4çš„ç©ºç™½ä½ç½®ã€‚
## æ•°ç‹¬è§„åˆ™
- æ ¹æ®æ•°ç‹¬çŸ©é˜µä¸­å·²ç»™å‡ºçš„æ•°å­—æ¨æµ‹â€œ_â€å¤„çš„æ•°å­—
- æ¯è¡Œï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡
- æ¯åˆ—ï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡  
- æ¯ä¸ª2Ã—2å®«æ ¼ï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡
## è§£é¢˜æµç¨‹
1. é€‰æ‹©ä¸€å¤„ç©ºç™½ä½ç½®â€œ_â€ï¼ŒæŒ‰è¡Œã€åˆ—ã€å®«æ ¼åˆ†æåº”è¯¥å¡«å…¥çš„æ•°å­—
2. æ‰“å°å¡«è¡¥ä¸€å¤„ç©ºç™½çš„çŸ©é˜µï¼Œåˆ¤æ–­è¯¥æ¬¡å¡«å……æ˜¯å¦æ­£ç¡®
3. é‡å¤æµç¨‹1ï¼Œç›´è‡³æ‰€æœ‰ç©ºç™½ä½ç½®â€œ_â€è¢«å¡«å®Œã€‚
## è¾“å‡ºæ ¼å¼
è¾“å‡ºæ ¼å¼ä¸º<think>...</think>\n<answer>...</answer>
åœ¨<think>...</think>ä¸­å¡«å…¥æ€è€ƒè¿‡ç¨‹
åœ¨<answer>...</answer>ä¸­å¡«å†™python Listæ ¼å¼çš„æœ€ç»ˆçŸ©é˜µ
è¾“å‡ºæ ¼å¼æ¡ˆä¾‹ï¼š
<think>
è¯¦ç»†æ¨ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ï¼š
- ä¸€æ­¥æ­¥çš„æ€è€ƒè¿‡ç¨‹
- å¯¹é¢˜ç›®çš„å¤è¿°ï¼Œä»¥åŠè¦åˆ†æçš„ç©ºç™½ä½ç½®
- å¡«å…¥ç©ºç™½ä½ç½®çš„æ•°å­—ä»¥åŠç†ç”±ï¼ŒæŒ‰è¡Œã€åˆ—ã€å®«æ ¼è§„åˆ™åˆ†æ
- æ£€æŸ¥å¡«å…¥åçš„æ•°ç‹¬çŸ©é˜µï¼Œç¡®ä¿ç¬¦åˆæ•°ç‹¬è§„åˆ™ï¼Œç¡®ä¿æ²¡æœ‰ä¿®æ”¹é¢˜ç›®é™å®šæ¡ä»¶
</think>
<answer>[[1,2,3,4],[4,3,...],...]</answer>
## æ•°ç‹¬é¢˜ç›®ï¼š
{}"""

SUDOKU_FORMAT = "[[{},{},{},{}],\n[{},{},{},{}],\n[{},{},{},{}],\n[{},{},{},{}]]"
# SUDOKU_FORMAT = r"""
# \[ \begin{{bmatrix}}
# {} & {} & {} & {} \\
# {} & {} & {} & {} \\
# {} & {} & {} & {} \\
# {} & {} & {} & {} \\
# \end{{bmatrix}}
# \]
# """

################################################
# å¥–åŠ±å‡½æ•°
################################################

## æ ¼å¼å‡†ç¡®å¥–åŠ±
def format_reward_func(completions, prompts, **kwargs):

    """Reward function that checks if the completion has a specific format."""
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                # åˆ¤æ–­æ•°å­—æ˜¯16ä¸ªï¼Œä¸”éƒ½åœ¨1-4
                if len(number) == 16 and all(0 < x < 5 for x in number):
                    rewards.append(1.0)
                else:
                    rewards.append(0.0)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.6 for r in rewards]

    # æ‰“å°ç¬¬ä¸€ç»„
    prompt_content = prompts[0][0]["content"]
    print("#" * 20, " æ‰“å°æ¨ç†æ¡ˆä¾‹ ", "#" * 20)
    print(prompt_content[-111:], "\næ¨¡å‹å›å¤ï¼š\n", completions[0][0]["content"])
    print("æ ¼å¼å‡†ç¡®å¥–åŠ±ï¼š", rewards[0])

    return rewards


## é•¿åº¦å¥–åŠ±
def len_reward_func(completions, **kwargs):
    """Reward function for response len."""
    content_len = [len(completion[0]["content"]) for completion in completions]
    rewards = []
    for clen in content_len:
        if clen < 1648 - 64:  # 2048-400=1648
            rewards.append(1.0)
        else:
            rw = (1648 - clen) / 64
            rewards.append(rw if rw >= 0 else 0.0)
    rewards = [r * 0.4 for r in rewards]

    # æ‰“å°ç¬¬ä¸€ç»„
    print("é•¿åº¦å¥–åŠ±ï¼š", rewards[0])

    return rewards

## é—®é¢˜æè¿°å‡†ç¡®å¥–åŠ±
def question_match_reward(completions, question, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match, qs_str in zip(matches, question):
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                question_match_num = sum(
                    1 for a, b in zip(numberstr, qs_str) if b != "_" and a == b
                )
                question_match_rate = question_match_num / (16 - qs_str.count("_"))
                rewards.append(question_match_rate)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 1.0 for r in rewards]

    # æ‰“å°ç¬¬ä¸€ç»„
    print("é—®é¢˜æè¿°å‡†ç¡®å¥–åŠ±ï¼š", rewards[0])

    return rewards

## æ•°ç‹¬è¡Œå‡†ç¡®è¯„ä¼°
def ans_row_reward(completions, answer, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                if len(number) != 16:
                    rewards.append(0.0)
                else:
                    matrix_4x4 = np.array(number).reshape(4, 4)
                    reward = [len(np.unique(row)) / 4 for row in matrix_4x4]
                    rewards.append(sum(reward) / 4)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.4 for r in rewards]

    # æ‰“å°ç¬¬ä¸€ç»„
    print("æ•°ç‹¬è¡Œå‡†ç¡®è¯„ä¼°ï¼š", rewards[0])

    return rewards

## æ•°ç‹¬åˆ—å‡†ç¡®è¯„ä¼°
def ans_col_reward(completions, answer, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                if len(number) != 16:
                    rewards.append(0.0)
                else:
                    matrix_4x4 = np.array(number).reshape(4, 4)
                    matrix_4x4 = matrix_4x4.T
                    reward = [len(np.unique(row)) / 4 for row in matrix_4x4]
                    rewards.append(sum(reward) / 4)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.3 for r in rewards]

    # æ‰“å°ç¬¬ä¸€ç»„
    print("æ•°ç‹¬åˆ—å‡†ç¡®è¯„ä¼°ï¼š", rewards[0])

    return rewards

## æ•°ç‹¬å—å‡†ç¡®è¯„ä¼°
def ans_block_reward(completions, answer, **kwargs):
    pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"
    completion_contents = [completion[0]["content"] for completion in completions]
    matches = [re.match(pattern, content, re.DOTALL) for content in completion_contents]
    rewards = []
    for match in matches:
        if match:
            try:
                numberstr = re.findall(r"\d+", match.group(1))
                number = list(map(int, numberstr))
                if len(number) != 16:
                    rewards.append(0.0)
                else:
                    matrix_4x4 = np.array(number).reshape(4, 4)
                    reward = 0
                    reward += len(np.unique(matrix_4x4[0:2, 0:2])) / 4
                    reward += len(np.unique(matrix_4x4[0:2, 2:4])) / 4
                    reward += len(np.unique(matrix_4x4[2:4, 0:2])) / 4
                    reward += len(np.unique(matrix_4x4[2:4, 2:4])) / 4
                    rewards.append(reward / 4)
            except:
                rewards.append(0.0)
        else:
            rewards.append(0.0)
    rewards = [r * 0.3 for r in rewards]

    # æ‰“å°ç¬¬ä¸€ç»„
    print("æ•°ç‹¬å—å‡†ç¡®è¯„ä¼°ï¼š", rewards[0])

    return rewards


################################################
# åŸºäºtrlå®ç°GRPOè®­ç»ƒè¿‡ç¨‹
################################################
def grpo_function(
    model_args: ModelConfig, dataset_args: DatasetArguments, training_args: GRPOConfig
):
    ################################################
    # è¯»å–æ•°æ® & åŠ è½½æ•°æ®
    ################################################
    sudoku_dataset = datasets.load_dataset(
        dataset_args.dataset_id_or_path, data_files=dataset_args.data_files
    )
    sudoku_dataset = sudoku_dataset.filter(lambda x: x["label"] == "simple")
    sudoku_dataset = sudoku_dataset.shuffle(seed=42)  # å›ºå®šseedæ‰“ä¹±
    train_dataset,eval_dataset = sudoku_dataset["train"].train_test_split(test_size=0.1, seed=42)

    def make_conversation(example):
        sudo_str = SUDOKU_FORMAT.format(*[c for c in example["question"]])
        user_prompt = PROMPT_TEMPLATE.format(sudo_str)
        return {
            "prompt": [
                {"role": "user", "content": user_prompt},
            ],
            "answer": [int(c) for c in example["answer"]],
        }

    train_dataset = train_dataset.map(make_conversation)
    eval_dataset = eval_dataset.map(make_conversation)

    ################################################
    # è®¾ç½® GRPOTrainer & å¼€å¯è®­ç»ƒ
    ################################################
    trainer = GRPOTrainer(
        model=model_args.model_name_or_path,  # æ¨¡å‹åç§°æˆ–è·¯å¾„
        # å¥–åŠ±å‡½æ•°åˆ—è¡¨ï¼Œç”¨äºè®¡ç®—å¥–åŠ±åˆ†æ•°
        reward_funcs=[
            format_reward_func,
            len_reward_func,
            question_match_reward,
            ans_row_reward,
            ans_col_reward,
            ans_block_reward,
        ],
        args=training_args,
        train_dataset=train_dataset,
        eval_dataset=eval_dataset,
        peft_config=get_peft_config(model_args),
    )
    trainer.train()

    ################################################
    # ä¿å­˜è®­ç»ƒç»“æœ
    ################################################
    trainer.save_model(training_args.output_dir)
    print(f"Model and Tokenizer saved to {training_args.output_dir}")
    print("*** Training complete! ***")


if __name__ == "__main__":
    """ä¸»å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œä¸»è®­ç»ƒå¾ªç¯"""
    # è§£æå‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®æ–‡ä»¶
    parser = TrlParser((ModelConfig, DatasetArguments, GRPOConfig))
    args = parser.parse_args_and_config()
    # è¿è¡Œä¸»è®­ç»ƒå¾ªç¯
    grpo_function(*args)
```

> æˆ‘ä»¬çš„å®éªŒå¯¹äºæ•°æ®éƒ¨åˆ†åªä½¿ç”¨äº†`label=simple`çš„éƒ¨åˆ†æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åªè®©æ¨¡å‹å¡«ç©º4ä¸ªåœ°æ–¹çš„æ•°å­—ï¼Œå¦‚æœæŒ–ç©ºæ¯”è¾ƒå¤šï¼ŒåŒæ—¶ç”±äºæˆ‘ä»¬è®¾ç½®çš„æŒ–ç©ºæ•°é‡å¹¶ä¸éšæœºï¼Œæ¨¡å‹å¯èƒ½ä¼šæ€è€ƒå¾ˆé•¿æ—¶é—´ï¼Œå¦‚æœæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å°è¯•ä¸‹ç”¨æŒ–ç©ºæ›´å¤šçš„æ•°æ®åšè®­ç»ƒæŸ¥çœ‹æ•ˆæœã€‚

**è®­ç»ƒå¯åŠ¨å‘½ä»¤**

ç”±äºæˆ‘ä»¬åœ¨è®­ç»ƒä»£ç ä¸­æœªæ·»åŠ å„ç§å‚æ•°configè®¾ç½®ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¦å¤–çš„æ–‡ä»¶å»é…ç½®è¿™äº›è¶…å‚æ•°ï¼Œç„¶åæˆ‘ä»¬çš„å®éªŒéƒ½ä½¿ç”¨`accelerate`åˆ†å¸ƒå¼è®­ç»ƒæ¥å®ç°è®­ç»ƒçš„åŠ é€Ÿã€‚

```python
# è®­ç»ƒæ–‡ä»¶
â”œâ”€â”€configs/   # å‚æ•°é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ deepspeed_zero3.yaml  # deepspeedå‚æ•°é…ç½®
â”‚   â”œâ”€â”€ grpo_qwen2.5-7b-it_lora.yaml  # 7Bæ¨¡å‹çš„å‚æ•°é…ç½®
â”‚   â””â”€â”€ grpo_qwen2.5-3b-it_lora.yaml  # 3Bæ¨¡å‹çš„å‚æ•°é…ç½®
â”œâ”€â”€scripts/   # è®­ç»ƒå¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ train_grpo.sh
â””â”€â”€ train_grpo.py
```

å¦‚æœä¸ç”¨`vllm`åšæ¨ç†åŠ é€Ÿï¼Œé‚£ä¹ˆç›´æ¥è¿è¡Œä¸‹é¢çš„ä»£ç å°±å¯ä»¥è®­ç»ƒï¼š

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3 bash ./scripts/train_grpo.sh
```

**ä½¿ç”¨vllmåšæ¨ç†åŠ é€Ÿ**

å¦‚æœéœ€è¦`vllm`åšæ¨ç†åŠ é€Ÿï¼ˆå› ä¸ºéœ€è¦æ¨¡å‹ç”Ÿæˆç­”æ¡ˆé‡‡æ ·ï¼Œå› æ­¤vllmå¯ä»¥åŠ é€Ÿè¿™éƒ¨åˆ†æ¨ç†è¿‡ç¨‹ï¼Œé€šå¸¸æˆ‘ä»¬çš„é‡‡æ ·æ•°æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬çš„å®éªŒè®¾ç½®ä¸º`num_generations=6`ï¼Œè¿™éƒ¨åˆ†ä¼šå¯¼è‡´æ•´ä½“æ—¶é—´å»¶é•¿ï¼Œä½†æ˜¯æœ¬èº«å¹¶ä¸èƒ½ç”¨äºåŠ é€Ÿè®­ç»ƒï¼Œä»…åŠ é€Ÿæ¨ç†ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€å—å¡ä½œä¸ºæ¨ç†å¡ä½¿ç”¨vllmæœåŠ¡ï¼Œå‰©ä¸‹çš„å¡ç”¨äºæ¨¡å‹è®­ç»ƒã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtrlå’Œvllmé€‚é…ä¸èƒ½ç›´æ¥ç”¨`vllm serve --model /your/model/path`å‘½ä»¤ï¼Œè€Œæ˜¯å‚è€ƒ[å®˜æ–¹ä»£ç ](https://huggingface.co/docs/trl/main/en/vllm_integration#-what-exactly-happens-when-you-run-trl-vllm-serve---model-ltmodelnamegt-)åï¼Œä½¿ç”¨`trl vllm-serve /your/model/path`å¼€å¯vllmæœåŠ¡åšæ¨ç†ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥ç›´æ¥è¿è¡Œä¸‹é¢çš„ä»£ç çœ‹çœ‹å®é™…åº”è¯¥æ€ä¹ˆä½¿ç”¨ï¼Œä¸è¿‡åœ¨è¿è¡Œä»£ç å‰ï¼Œéœ€è¦å°†`config`æ–‡ä»¶ä¸­`use_vllm`æ”¹æˆ`True`ï¼Œè¯¦ç»†å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ğŸ‘‰[åœ°å€](https://huggingface.co/docs/trl/main/en/speeding_up_training?vllm+examples=GRPO#vllm-for-fast-generation-in-online-methods)ã€‚

```bash
trl -h
```

é¦–å…ˆæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªå—ä½œä¸ºæ¨ç†ä½¿ç”¨ï¼Œè¦æ³¨æ„å•å¡ç¡®ä¿èƒ½è·‘æ¨¡å‹ï¼Œä¸ç„¶æ˜¾å­˜ä¸å¤Ÿã€‚å‡å¦‚æˆ‘ä»¬æ˜¯3å¡ï¼Œæˆ‘ä»¬ä»¤ç¬¬ä¸‰å—å¡ä¸ºæ¨ç†å¡ï¼š

```bash
CUDA_VISIBLE_DEVICES=2 trl vllm-serve /your/path/of/model
```

ç„¶ååœ¨å‰©ä¸‹ä¸¤å—å¡ä¸Šè·‘è®­ç»ƒä»»åŠ¡

```bash
CUDA_VISIBLE_DEVICES=0,1 bash ./scripts/train_grpo.sh
```

**åˆå¹¶æ¨¡å‹**

åˆ«å¿˜äº†æœ€åæ¨¡å‹å‚æ•°åˆå¹¶ï¼Œæˆ‘ä»¬ä½¿ç”¨LoRAçš„æ–¹å¼è¿›è¡Œè®­ç»ƒï¼Œå‚æ•°éœ€è¦å’ŒåŸæ¨¡å‹è¿›è¡Œåˆå¹¶ï¼Œè¿è¡Œä¸‹é¢çš„ä»£ç ï¼š

```bash
python ./merge/merge-lora.py \
        --lora_path /root/autodl-tmp/models/outputs/grpo_qwen2.5-3b-it_lora \
        --base_model_path /root/autodl-tmp/models/qwen/qwen2.5-3b-it \
        --merge_path /root/autodl-tmp/models/outputs/merged-model-gpu
```

- `lora_path`:è®­ç»ƒå®Œæˆåä¿å­˜çš„loraå‚æ•°åœ°å€
- `base_model_path`:åŸæ¨¡å‹ä¿å­˜åœ°å€
- `merge_path`:åˆå¹¶åæ¨¡å‹ä¿å­˜åœ°å€

## 4ã€ç»“æœè¯„æµ‹

å¯¹äºè®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶æ•ˆæœè¿›è¡Œè¯„æµ‹ï¼Œæˆ‘ä»¬æƒ³æµ‹è¯•ä¸‹æ•°ç‹¬æ¸¸æˆä»»åŠ¡çš„å®Œæˆæ•ˆæœï¼Œå› æ­¤æµ‹è¯•ä»£ç ä»ç„¶éœ€è¦æˆ‘ä»¬æ¥è®¾è®¡ï¼ŒåŸç†å’Œè®­ç»ƒæ—¶è®¾è®¡å¥–åŠ±æ¨¡å‹ä¸€æ ·ï¼Œä¹Ÿæ˜¯æ ¼å¼ã€è§„åˆ™ç¬¦åˆå°±è¡Œã€‚

ä¸è¿‡æœ‰æ‰€ä¸åŒçš„æ˜¯ï¼Œè®­ç»ƒçš„æ—¶å€™é”™ä¸€ä¸ªæ•°å­—æ‰æ‰£ä¸€äº›åˆ†æ•°ï¼Œä½†æ˜¯æµ‹è¯•çš„æ—¶å€™åªè¦æœ‰ä¸€ä¸ªæ•°å­—é”™è¯¯ï¼Œå°±æŒ‰ç…§0åˆ†æ¥ç®—ï¼Œåªæœ‰å…¨éƒ¨æ­£ç¡®ï¼Œæ‰ç®—1åˆ†ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨æµ‹è¯•é˜¶æ®µéœ€è¦æ›´å…³æ³¨äºæ¨¡å‹çš„æ¨ç†èƒ½åŠ›ã€‚

ç„¶åæˆ‘ä»¬ç”Ÿæˆ300ä¸ªæ•°æ®ï¼Œç»Ÿè®¡å®Œå…¨æ­£ç¡®çš„ä¸ªæ•°/300æ¥è®¡ç®—å‡†ç¡®ç‡ã€‚

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train5.png" style="width:100%">
  </figure>
</div>

æˆ‘ä»¬æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ¥ä¾æ¬¡å®ç°ï¼š

1. å¼€å¯vllmæœåŠ¡ï¼š

å› ä¸ºå¾…è¯„æµ‹æ•°æ®é›†çš„ç”Ÿæˆå…¶å®å°±æ˜¯æ¨ç†è¿‡ç¨‹ï¼Œå› æ­¤éœ€è¦å…ˆå¼€å¯ä¸€ä¸ªvllmæœåŠ¡ï¼Œç„¶åé€šè¿‡openaiæ¥å£å®ç°è¿œç¨‹vllmæœåŠ¡æ¨ç†ï¼Œæœ‰æ•ˆåŠ é€Ÿæ•°æ®çš„ç”Ÿæˆã€‚

```bash
vllm serve /your/path/of/model
```

2. ç”Ÿæˆå¾…è¯„æµ‹æ•°æ®é›†

æˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€æ‰¹ç»“æœæ•°æ®ï¼Œç”¨äºåé¢æ‰“åˆ†ï¼Œå¹¶ä¸”åŸæ¨¡å‹ä¹Ÿç”Ÿæˆä¸€æ‰¹ï¼Œå¯ä»¥å¯¹æ¯”æ•ˆæœï¼Œçœ‹GRPOæ˜¯å¦æå‡äº†åšæ•°ç‹¬æ¸¸æˆçš„å‡†ç¡®åº¦ã€‚

```bash
bash ./eval/generate.sh
```

è¯¥å‡½æ•°æœ‰ä¸‹é¢å‡ ä¸ªå‚æ•°ï¼Œè¿™é‡Œç®€å•è§£é‡Šä¸‹ï¼š

- `input_file`:åœ¨æ•°æ®ç”Ÿæˆé˜¶æ®µç”Ÿæˆçš„æ•°æ®é›†ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°`question`éƒ¨åˆ†ä½œä¸ºé—®é¢˜è®©æ¨¡å‹ç”Ÿæˆå›ç­”æ•°æ®é›†è¿›è¡Œæµ‹è¯•ï¼Œé»˜è®¤ä¸º`sudoku_4x4_qa.jsonl`

- `output_file`:ç”¨äºåç»­æµ‹è¯•ç”¨ï¼Œåˆ©ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å’ŒåŸæ¨¡å‹ç”Ÿæˆçš„æ•°æ®é›†ä¿å­˜åœ°å€

- `num_completions_to_generate`:æ€»å…±ç”Ÿæˆnæ¡æ•°æ®ç”¨äºæµ‹è¯•

- `model_name`:ç”¨äºæµ‹è¯•çš„æœ¬åœ°æ¨¡å‹åœ°å€ï¼Œæµ‹è¯•éœ€è¦åˆ†åˆ«ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹å’Œè®­ç»ƒå‰çš„åŸæ¨¡å‹

- `temperature`:è°ƒèŠ‚è¾“å‡ºæ–‡æœ¬éšæœºæ€§ä¸ç¡®å®šæ€§çš„å‚æ•°ï¼Œæ•°å€¼è¶Šé«˜éšæœºæ€§è¶Šå¼ºã€ç¡®å®šæ€§è¶Šå¼±ï¼Œåä¹‹ç›¸åï¼Œè¿™é‡Œé»˜è®¤ä¸º0ï¼Œç”¨äºæ¨¡å‹ç¡®å®šæ€§è¾“å‡ºè§£ç­”æµ‹è¯•æ•ˆæœ

- `top_p`:æŒ‰æ¦‚ç‡ä»é«˜åˆ°ä½ç­›é€‰å€™é€‰è¯ã€ç›´è‡³ç´¯ç§¯æ¦‚ç‡è¾¾åˆ°på€¼å†ä»ä¸­é‡‡æ ·çš„å‚æ•°ï¼Œç”±äºé»˜è®¤`temperature=0`ï¼Œ`top_p`å…¶å®å¤±æ•ˆï¼Œä¸è¿‡å¦‚æœè¦æµ‹è¯•åœ¨`temperature>0`çš„æƒ…å†µä¸‹æ¨¡å‹çš„æ•ˆæœï¼Œä¹Ÿå°±æ˜¯ç¡®ä¿æ¨¡å‹ä¸°å¯Œåº¦çš„æƒ…å†µä¸‹æ˜¯å¦è¿˜èƒ½å›ç­”æ­£ç¡®ï¼Œ`top_p`å¯ä»¥è°ƒæ•´ï¼Œè¿™é‡Œé»˜è®¤ä¸º1ã€‚
3. è¯„ä¼°ç»“æœ

è¿è¡Œä¸‹é¢çš„ä»£ç å¯ä»¥ç›´æ¥å°†ç”Ÿæˆçš„ç»“æœæ•°æ®è¿›è¡Œè¯„ä¼°ï¼Œå¾—åˆ°æœ€ç»ˆçš„å‡†ç¡®åº¦ï¼š

```python
python ./eval/eval.py
```

æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°äº†ç»“æœæ•°æ®ï¼š

<div style="display:flex;justify-content:center;">
  <figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train4.png" style="width:100%">
  </figure>
</div>

å…¶ä¸­å„ä¸ªå‚æ•°è¡¨è¾¾å¦‚ä¸‹ï¼š

- `mean_scores`:ä½¿ç”¨åŸå§‹å¥–åŠ±å‡½æ•°ç»Ÿè®¡çš„åˆ†æ•°ï¼Œæ¯”å¦‚æŸä¸ªæ•°ç‹¬æ¸¸æˆé—®é¢˜ï¼Œå›ç­”çš„ç­”æ¡ˆä¸­å¦‚æœåªæœ‰ä¸€ä¸ªæ•°å­—ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™æŒ‰ç…§é”™è¯¯çš„ä¸ªæ•°æ‰£åˆ†ï¼Œä½†æ˜¯ä¸ç›´æ¥è®¾ç½®ä¸º0ï¼Œç„¶åç»Ÿè®¡å®Œæ‰€æœ‰çš„æ•°æ®æ±‚å¹³å‡å¾—åˆ°çš„ç»“æœã€‚**(è¿™ä¸ªåˆ†æ•°æ˜¯æˆ‘æœ€å¼€å§‹æµ‹è¯•æ—¶ä½¿ç”¨ï¼Œè¦ç”¨åé¢çš„`num_score`ï¼Œè¿™ä¸ªåˆ†æ•°æ‰æ›´åé‡äºå‡†ç¡®åº¦çš„æµ‹è¯•ï¼Œå› æ­¤`mean_scores`ä¸å‚è€ƒä¹Ÿå¯ä»¥)**
  
  - `format_mean`:æ ¼å¼æ­£ç¡®åˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦éµå®ˆ\<think>\</think>\<answer>\</answer>å¹¶ä¸”ç»“æœä¸­åŒ…å«çš„æ•°å­—ä¸º16ä¸ª
  
  - `question_mean`:é—®é¢˜ä¿æŒåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ç”Ÿæˆçš„å›ç­”æ²¡æœ‰è¢«æ¨¡å‹æ”¹é¢˜
  
  - `row_mean`:è¡Œè§„åˆ™éµå®ˆåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ä¿è¯æ¯è¡Œæ˜¯1-4ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤
  
  - `col_mean`:åˆ—è§„åˆ™éµå®ˆåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ä¿è¯æ¯åˆ—æ˜¯1-4ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤
  
  - `block_mean`:å®«æ ¼è§„åˆ™éµå®ˆåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ä¿è¯æ¯ä¸ª2\*2å°å®«æ ¼æ˜¯1-4ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤
    
    ä¸‹é¢æ˜¯`format_mean`åˆ†æ•°ç»Ÿè®¡çš„åŸç†å›¾ï¼Œå…¶ä»–åˆ†æ•°åŸç†ç›¸åŒï¼š
    
    <div style="display:flex;justify-content:center;">
    <figure style="text-align:center;margin:0;">
      <img src="./grpo_train/train6.png" style="width:90%">
    </figure>
    </div>

- `num_score`:è¿˜æ˜¯ä½¿ç”¨åŸå§‹å¥–åŠ±å‡½æ•°ï¼Œä½†æ˜¯éœ€è¦å¯¹äºåˆ†æ•°è¦æ±‚æ›´åŠ ä¸¥æ ¼ã€‚æ ¼å¼ã€é—®é¢˜ä¿æŒä»¥åŠæ•°ç‹¬è§„åˆ™çš„åˆ†æ•°åªè¦ä¸æ˜¯æ»¡åˆ†ï¼Œå°±æŒ‰ç…§0åˆ†æ¥ç®—ï¼Œé™¤éæ»¡åˆ†æ‰ç®—1åˆ†ï¼Œç„¶åå¯¹æ‰€æœ‰çš„æ•°æ®æ±‚å¹³å‡ã€‚çº¢æ¡†ä¸­æ˜¯æˆ‘ä»¬åº”è¯¥å…³æ³¨çš„å‚æ•°ã€‚
  
  <div style="display:flex;justify-content:center;">
    <figure style="text-align:center;margin:0;">
        <img src="./grpo_train/train7.png" style="width:100%">
    </figure>
    </div>
  
    **å…¶ä¸­`total_score`çš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š**
  
  <div style="display:flex;justify-content:center;">
    <figure style="text-align:center;margin:0;">
        <img src="./grpo_train/train9.png" style="width:100%">
    </figure>
    </div>
  
  - `format_score`:æ ¼å¼æ­£ç¡®åˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦*å®Œç¾*éµå®ˆ\<think>\</think>\<answer>\</answer>å¹¶ä¸”ç»“æœä¸­åŒ…å«çš„æ•°å­—ä¸º16ä¸ª
  - `question_score`:é—®é¢˜ä¿æŒåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ç”Ÿæˆçš„å›ç­”*å®Œå…¨*æ²¡æœ‰è¢«æ¨¡å‹æ”¹é¢˜
  - `row_score`:è¡Œè§„åˆ™éµå®ˆåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ä¿è¯æ¯è¡Œæ˜¯1-4ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤
  - `col_score`:åˆ—è§„åˆ™éµå®ˆåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ä¿è¯æ¯åˆ—æ˜¯1-4ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤
  - `block_score`:å®«æ ¼è§„åˆ™éµå®ˆåˆ†æ•°ï¼Œç»Ÿè®¡æ˜¯å¦ä¿è¯æ¯ä¸ª2\*2å°å®«æ ¼æ˜¯1-4ï¼Œå¹¶ä¸”æ²¡æœ‰é‡å¤
  - **`total_score`:ç»Ÿè®¡åŒæ—¶ç¬¦åˆè¡Œã€åˆ—ã€å®«æ ¼è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯ä¸‰ä¸ªéƒ½æ˜¯æ»¡åˆ†çš„æƒ…å†µçš„æ•°æ®çš„ä¸ªæ•°**
  - `format_exclude`:ä¸Šé¢çš„`total_score/format_score`ï¼Œå°½é‡æ’é™¤æ ¼å¼å¸¦æ¥çš„å¯èƒ½ç­”æ¡ˆå‡†ç¡®çš„å½±å“ï¼Œå°±æ˜¯å¯èƒ½ç­”æ¡ˆæ˜¯å¯¹çš„ï¼Œä½†æ˜¯æ ¼å¼ä¸æ˜¯æŒ‰ç…§æ ‡å‡†æ ¼å¼è¾“å‡ºçš„ï¼Œä½†æ˜¯è¯¥å‚æ•°å…¶å®æ„ä¹‰ä¸å¤§ï¼Œå› ä¸ºåœ¨æ¯ä¸ªå¥–åŠ±å‡½æ•°ä¸­æˆ‘æ·»åŠ äº†æ­£åˆ™åŒ–`pattern = r"^<think>[\s\S]*?</think>\s*<answer>([\s\S]*?)</answer>$"`ä»£ç ï¼Œå¦‚æœä¸éµå®ˆè§„åˆ™ï¼Œé‚£ä¹ˆæ ¹æœ¬è¿åˆ†æ•°éƒ½è®°å½•ä¸äº†ã€‚

<div style="background:#e7f8ff;color:#000;padding:12px 16px;border-left:4px solid #20c0ff;">
ç»è¿‡GRPOè®­ç»ƒçš„æ¨¡å‹å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„å‡†ç¡®åº¦ï¼Œé’ˆå¯¹è§„åˆ™éµå®ˆçš„æµ‹è¯•ç»“æœtotal_scoreç›¸æ¯”äºåŸæ¨¡å‹qwen2.5-7b-instructï¼Œè®­ç»ƒåçš„æ¨¡å‹æé«˜äº†0.48çš„å‡†ç¡®åº¦ï¼Œè¿™è¯æ˜äº†æˆ‘ä»¬å®éªŒçš„å¯è¡Œæ€§ã€‚
</div>

# NPUè®­ç»ƒä»£ç 

è¯¥éƒ¨åˆ†è®­ç»ƒä»£ç å’Œä¸Šè¿°ä»£ç æ˜¯åŒä¸€ä¸ªï¼Œä½†æ˜¯å¯åŠ¨å‘½ä»¤ä¸å¤ªä¸€æ ·ï¼ŒNPUæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨`vllm`æ¥åŠ é€Ÿæ¨ç†ï¼Œå¹¶ä¸”ç”±äºæ²¡åŠæ³•å®‰è£…`tmux`ï¼Œç¦»çº¿è®­ç»ƒçš„è¯å¾—ç”¨å¦å¤–çš„å‘½ä»¤ï¼š

è®­ç»ƒå¯åŠ¨å‘½ä»¤ï¼š

```bash
ASCEND_RT_VISIBLE_DEVICES=0,1,2,3 bash ./scripts/train_grpo_nohup_npu.sh
```

åˆå¹¶æ¨¡å‹ï¼š

```bash
python ./merge/merge-lora.py
```

ç»“æœè¯„æµ‹ï¼š

1. ç”Ÿæˆæ•°æ®

```bash
bash ./eval/generate.sh
```

2. è¯„ä¼°åˆ†æ•°

```bash
python ./eval/eval.py
```

# SwanLabç»“æœè§‚æµ‹

æˆ‘ä»¬ä¸»è¦éœ€è¦è§‚å¯Ÿæ¯ä¸ª`reward`çš„å¹³å‡å€¼`mean`ï¼Œè¿™ä¸ªä»£è¡¨ç€GRPOä¸­æ¯ä¸ªè¾“å‡ºç»è¿‡å¥–åŠ±å‡½æ•°å¾—åˆ°çš„ä¼˜åŠ¿$A_i$å€¼ï¼Œæ±‚å‡º`num_generations`ä¸ªè¾“å‡ºçš„å¹³å‡å€¼ä½œä¸ºå®é™…çš„å¥–åŠ±å€¼ã€‚

`reward`å¾ˆå¤šï¼Œæ¯ä¸ªæ»¡åˆ†å¯èƒ½éƒ½ä¸ä¸€æ ·ï¼Œå› ä¸ºåšå®¢è¿‡é•¿ï¼Œä¼°è®¡å¤§å®¶éƒ½å¿«å¿˜äº†å¥–åŠ±åˆ†æ•°å¤šå°‘äº†ï¼Œè¿™é‡Œå†é‡å¤ä¸€éï¼š

- `format_reward`:0.6ï¼Œæ ¼å¼éµä»å¥–åŠ±
- `len_reward`:0.4ï¼Œé•¿åº¦é™åˆ¶å¥–åŠ±
- `question_match_reward`:1.0ï¼Œé—®é¢˜ä¿æŒå¥–åŠ±
- `ans_row_reward`:0.4ï¼Œè¡Œè§„åˆ™å¥–åŠ±
- `ans_col_reward`:0.3ï¼Œåˆ—è§„åˆ™å¥–åŠ±
- `ans_block_reward`:0.3ï¼Œå®«æ ¼è§„åˆ™å¥–åŠ±

***æˆ‘ä»¬æ‰€æœ‰çš„ç»“æœåœ¨è¿™ä¸ªé¡¹ç›®ä¸­ğŸ‘‰[SwanLab](https://swanlab.cn/@LiXinYu/sudoku-grpo-qwen2.5/overview)ï¼Œå¯ä»¥æŸ¥çœ‹æ¯ä¸ªå®éªŒçš„è®­ç»ƒè¿‡ç¨‹ä»¥åŠå‚æ•°è®¾ç½®***

ä¸‹é¢å±•ç¤ºä¸‹æ‰€æœ‰å®éªŒçš„ç»“æœğŸ‘‡ï¼š

| æ¨¡å‹å®éªŒåç§°                          | æ¨¡å‹å‚æ•°é‡ | vllm | GPU | NPU |
|:------------------------------- |:-----:|:----:|:---:|:---:|
| grpo_qwen2.5-3B-it-lora-gpuvllm | 3B    | âœ…    | âœ…   | âŒ   |
| grpo_qwen2.5-3B-it-lora-gpu     | 3B    | âŒ    | âœ…   | âŒ   |
| grpo_qwen2.5-7B-it-lora-gpu     | 7B    | âŒ    | âœ…   | âŒ   |
| grpo_qwen2.5-3B-it_lora-npu     | 3B    | âŒ    | âŒ   | âœ…   |
| grpo_qwen2.5-7B-it_lora-npu     | 7B    | âŒ    | âŒ   | âœ…   |


**1. 3Bæ¨¡å‹loraå¼ºåŒ–å­¦ä¹ grpoè®­ç»ƒï¼ˆvllmâœ… GPUâœ…ï¼‰**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train10.png" style="width:100%">
</figure>
</div>

**2. 3Bæ¨¡å‹loraå¼ºåŒ–å­¦ä¹ grpoè®­ç»ƒï¼ˆvllmâŒ GPUâœ…ï¼‰**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train11.png" style="width:100%">
</figure>
</div>

**3Bæ¨¡å‹æœ‰æ— vllmå¯¹æ¯”è§‚å¯Ÿ**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train12.png" style="width:100%">
</figure>
</div>

> ä»å›¾è¡¨ä¸­å¯ä»¥çœ‹åˆ°ä½¿ç”¨`vllm`åæ•ˆæœä¸‹é™ï¼Œç”±äºå…¶ä»–å‚æ•°å…¨éƒ½ä¸å˜ï¼Œé‚£ä¹ˆå”¯ä¸€çš„å˜é‡è¿˜æ˜¯ä»`vllm`å¢åŠ æ¨ç†ååé‡çš„åŸç†å…¥æ‰‹ï¼Œå¤§æ¦‚æ€»ç»“ä¸ºä¸‹é¢å‡ ç‚¹ï¼š
> 
> 1. vLLMä¸ºäº†å®ç°æé«˜çš„ååé‡ï¼Œä½¿ç”¨äº†å¦‚PagedAttentionåœ¨å†…çš„æ ¸å¿ƒä¼˜åŒ–ã€‚è¿™äº›ä¼˜åŒ–å¯èƒ½ä¼šæ”¹å˜é‡‡æ ·æ—¶éšæœºæ•°ç”Ÿæˆçš„æ–¹å¼æˆ–é¡ºåºã€‚åœ¨ä¸ä½¿ç”¨vLLMæ—¶ï¼ˆä¾‹å¦‚ä½¿ç”¨æ ‡å‡†çš„Hugging Face transformersï¼‰ï¼Œéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆRNGï¼‰çš„çŠ¶æ€æ˜¯ç›¸å¯¹ç®€å•å’Œç¡®å®šçš„ã€‚è€Œåœ¨vLLMä¸­ï¼Œä¸ºäº†å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚ï¼ŒRNGçš„ç®¡ç†å˜å¾—æ›´åŠ å¤æ‚ã€‚å³ä½¿ä½ è®¾ç½®äº†ç›¸åŒçš„éšæœºç§å­ï¼ŒvLLMå’ŒåŸç”ŸPyTorchçš„é‡‡æ ·ç»“æœä¹Ÿå¯èƒ½å› ä¸ºå¹¶è¡Œè°ƒåº¦ã€å†…å­˜åˆ†é¡µç­‰å› ç´ è€Œäº§ç”Ÿå¾®å°å·®å¼‚ã€‚
> 2. vLLMä¸ºäº†è¿½æ±‚é€Ÿåº¦ï¼Œå¯èƒ½ä¼šåœ¨æŸäº›è®¡ç®—ä¸­ä½¿ç”¨æ··åˆç²¾åº¦ï¼ˆå¦‚FP16ã€BF16ï¼‰æˆ–ç‰¹å®šçš„å†…æ ¸ä¼˜åŒ–ï¼Œè¿™å¯èƒ½ä¼šå¼•å…¥å¾®å°çš„æ•°å€¼è¯¯å·®ã€‚
> - Logitså’Œæ¦‚ç‡çš„å·®å¼‚ï¼šæ¨¡å‹è¾“å‡ºçš„logitsåœ¨ç»è¿‡softmaxå˜æˆæ¦‚ç‡åˆ†å¸ƒæ—¶ï¼Œå¾®å°çš„æ•°å€¼å·®å¼‚ï¼ˆå°¤å…¶æ˜¯åœ¨ä½¿ç”¨FP16æ—¶ï¼‰å¯èƒ½ä¼šè¢«æ”¾å¤§ï¼Œå¯¼è‡´é‡‡æ ·æ—¶é€‰ä¸­ä¸åŒçš„tokenã€‚
> - æ¢¯åº¦è®¡ç®—çš„ç´¯ç§¯è¯¯å·®ï¼šåœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œè¿™äº›æ•°å€¼ç²¾åº¦çš„å·®å¼‚å¯èƒ½ä¼šç´¯ç§¯ï¼Œå¯¼è‡´æœ€ç»ˆçš„æƒé‡æ›´æ–°ä¸åŸç”ŸPyTorchç¯å¢ƒä¸‹çš„ç»“æœä¸åŒã€‚

ä¸è¿‡`vllm`ç¡®å®èƒ½æå¤§åœ°æé«˜è®­ç»ƒçš„æ•ˆç‡ï¼Œä¸‹é¢æ˜¯æœ‰æ— `vllm`çš„å®éªŒæ—¶é—´çš„å¯¹æ¯”å›¾ï¼š

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train13.png" style="width:80%">
</figure>
</div>

**3. 7Bæ¨¡å‹loraå¼ºåŒ–å­¦ä¹ grpoè®­ç»ƒï¼ˆvllmâŒ GPUâœ…ï¼‰**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train15.png" style="width:100%">
</figure>
</div>

**7Bæ¨¡å‹å’Œ3Bæ¨¡å‹çš„å¯¹æ¯”ï¼ˆvllmâŒ GPUâœ…ï¼‰**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train16.png" style="width:100%">
</figure>
</div>

> ç”±äº7Bæ¨¡å‹æœ¬èº«èƒ½åŠ›æ¯”3Bæ¨¡å‹è¦å¥½ä¸Šä¸å°‘ï¼Œå› æ­¤è®­ç»ƒçš„æ—¶å€™ä¸ä»…æ¯”3Bæ¨¡å‹æ›´å¿«çš„åˆ°è¾¾æ€§èƒ½æœ€é«˜ç‚¹ï¼Œè€Œä¸”æ•´ä½“çš„å‡†ç¡®åº¦ä¹Ÿæ¯”è¾ƒé«˜ã€‚

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train17.png" style="width:100%">
</figure>
</div>

> å¦å¤–ï¼Œ7Bæ¨¡å‹æ™®éæ¯”3Bæ¨¡å‹ç”¨æ›´å°‘çš„æ€è€ƒé•¿åº¦å¾—åˆ°æ­£ç¡®ç­”æ¡ˆ

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train18.png" style="width:100%">
</figure>
</div>

> `entropy`è¡¨ç¤ºçš„æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­çš„ç†µï¼ˆtrain/entropyï¼‰ï¼Œæ˜¯è¡¡é‡æ¨¡å‹è¾“å‡ºå¤šæ ·æ€§çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚ç†µï¼ˆEntropyï¼‰åœ¨è¿™é‡ŒæŒ‡çš„æ˜¯æ¨¡å‹é¢„æµ‹ token çš„æ¦‚ç‡åˆ†å¸ƒçš„ä¸ç¡®å®šæ€§ï¼Œå› æ­¤å€¼è¶Šé«˜ï¼Œç­”æ¡ˆçš„ä¸ç¡®å®šæ€§ä¹Ÿå°±è¶Šé«˜ï¼Œç”±äºæˆ‘ä»¬çš„ç­”æ¡ˆæ˜¯ç»“æ„åŒ–è¾“å‡ºï¼Œè€Œä¸”ç”±äºæ•°ç‹¬æŒ–ç©ºè¾ƒå°‘æ‰€ä»¥å¾ˆéš¾æœ‰å¤šä¸ªè§£çš„æƒ…å†µï¼Œå› æ­¤ç­”æ¡ˆè¶Šç¡®å®šè¶Šå¥½ã€‚

**4. 3Bæ¨¡å‹loraå¼ºåŒ–å­¦ä¹ GRPOçš„è®­ç»ƒï¼ˆvllmâŒ NPUâœ…ï¼‰**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train27.png" style="width:100%">
</figure>
</div>

**3Bæ¨¡å‹å’Œ7Bæ¨¡å‹çš„å¯¹æ¯”ï¼ˆvllmâŒ NPUâœ…ï¼‰**

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train28.png" style="width:100%">
</figure>
</div>

# è°ƒå‚æŠ€å·§

æˆ‘ä»¬åœ¨å®éªŒçš„æ—¶å€™å…¶å®é‡åˆ°äº†è®¸å¤šé—®é¢˜ï¼Œæœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬çš„æ›²çº¿éœ‡è¡ç‰¹åˆ«å‰§çƒˆï¼Œå¹¶ä¸”`reward`é€šå¸¸æ²¡æœ‰æå‡ï¼Œæˆ‘ä»¬å°è¯•äº†å¾ˆå¤šå‚æ•°è¿˜æœ‰æç¤ºè¯çš„è°ƒæ•´ï¼Œæ‰å¾—åˆ°æˆ‘ä»¬æœ€ç»ˆçš„å®éªŒæ•ˆæœï¼Œä¸‹é¢æˆ‘ä»¬ä¼šæ€»ç»“å‡ºé‡åˆ°çš„å‚æ•°è°ƒæ•´æŠ€å·§ï¼Œä»¥æ–¹ä¾¿å¤§å®¶å®é™…è®­ç»ƒçš„æ—¶å€™è¿…é€Ÿæ‰¾åˆ°é—®é¢˜ï¼š

**1ã€æ˜¾å­˜ä¸å¤Ÿ**

è¿™ä¸ªå…¶å®æ˜¯æ¯”è¾ƒåŸºç¡€çš„é—®é¢˜ï¼Œä¸è¿‡å¯¹äºå‚æ•°çš„è°ƒæ•´è¿˜æ˜¯éœ€è¦æ³¨æ„çš„ï¼ŒåŸºæœ¬è¦è°ƒæ•´çš„æœ‰ä»¥ä¸‹è¿™äº›å‚æ•°ï¼š

- `per_device_train_batch_size`
- `gradient_accumulation_steps`

å…¶ä¸­`per_device_train_batch_size`å¯¹æ˜¾å­˜å ç”¨çš„å½±å“æœ€å¤§ï¼Œåœ¨ç²¾åº¦éƒ½ä¸ºæ··åˆç²¾åº¦`bfloat16`æ¡ä»¶ä¸‹ï¼Œ`per_device_train_batch_size>2`çš„è¯3Bæ¨¡å‹4å¡5090è®­ç»ƒï¼Œ1å¡è·‘vllmæ¨ç†è·‘ä¸äº†ï¼Œä¸ç”¨vllmçš„è¯5å¡ä¹ŸåŒæ ·è·‘ä¸äº†ï¼Œå³ä½¿è®¾ç½®æ¢¯åº¦ç´¯è®¡é‡æ¯”è¾ƒé«˜ä¹Ÿä¸è¡Œã€‚

å†µä¸”æ•´ä½“çš„batchä¹Ÿè¦æ§åˆ¶ï¼Œ
`generation_batch_size=num_devices x per_device_train_batch_size x gradient_accumulation_steps`ï¼Œåœ¨SwanLabçš„å¡ç‰‡ä¸­ä¹Ÿå¯ä»¥ç›´æ¥çœ‹åˆ°æ•´ä½“çš„batchï¼Œæˆ‘ä»¬çš„å®éªŒç»Ÿä¸€æ˜¯24ã€‚

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train19.png" style="width:100%">
</figure>
</div>

æˆ‘ä»¬çš„æ•°æ®å…·ä½“å¦‚ä¸‹ï¼Œå¦‚æœæœ‰éœ€è¦å¯ä»¥å¯¹å…¶è¿›è¡Œè°ƒæ•´ï¼š

- `per_device_train_batch_size=2`
- `gradient_accumulation_steps=3`
- `num_devices=4`

å¯¹äºNPUï¼ˆ910B2ï¼‰çš„å®éªŒï¼Œæˆ‘ä»¬è®¾ä¸ºï¼š

- `per_device_train_batch_size=3`   # å› ä¸º910B2çš„æ˜¾å­˜ä¸º64GB
- `gradient_accumulation_steps=2`
- `num_devices=4`

**2ã€loraå‚æ•°**

å‰æœŸï¼Œæˆ‘è®¾ç½®è®­ç»ƒçš„æ¨¡å‹å±‚ä»…ä¸º`q_proj`, `k_proj`, `v_proj`ï¼Œä¸ä»…å¾ˆéš¾è¾¾åˆ°æ€§èƒ½æœ€é«˜ç‚¹ï¼Œå¹¶ä¸”`reward`çš„éœ‡è¡éå¸¸å‰§çƒˆï¼Œä¹Ÿå°±æ˜¯è¯´ç”Ÿæˆçš„æ‰€æœ‰çš„å›ç­”ä¹‹é—´å·®åˆ«å¾ˆå¤§ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³çœ‹åˆ°çš„ï¼Œå› æ­¤åç»­ç›´æ¥æ”¹æˆ`target_modules=all_linear`ï¼Œå°†æ‰€æœ‰çš„æ¨¡å‹å±‚éƒ½åŠ å…¥è®­ç»ƒï¼Œå…¶ä¸­ä¸»è¦æ˜¯`attention`è®¡ç®—éƒ¨åˆ†å’Œ`mlp`å±‚å‚ä¸è®­ç»ƒï¼Œè™½ç„¶**æ˜¾å­˜å ç”¨æé«˜ï¼Œä½†æ˜¯æ•ˆæœæé«˜äº†å¾ˆå¤šã€‚**

**3ã€â€¼ï¸rewardå‡½æ•°ä¼˜åŒ–**

å¥–åŠ±å‡½æ•°æ˜¯GRPOè®­ç»ƒçš„æ ¸å¿ƒå¯¼å‘ï¼Œå¯ä»¥ç›´æ¥å‘Šè¯‰æ¨¡å‹å®ƒå›ç­”çš„æ•ˆæœå¦‚ä½•ï¼Œç›´æ¥å†³å®šæ¨¡å‹ä¼˜åŒ–æ–¹å‘ä¸è®­ç»ƒæ•ˆæœã€‚åˆç†è®¾è®¡çš„å¥–åŠ±å‡½æ•°èƒ½ç²¾å‡†å¼•å¯¼ç­–ç•¥å­¦ä¹ ç›®æ ‡ï¼ˆå¦‚æå‡ç”Ÿæˆè´¨é‡ã€é€»è¾‘æ€§ï¼‰ï¼Œé€šè¿‡å¹³è¡¡æ‹Ÿåˆåº¦ä¸å¤šæ ·æ€§ï¼Œé¿å…æ¨¡å‹ç†µåç¼©æˆ–æ¨¡å¼å´©æºƒï¼ŒåŒæ—¶ç¨³å®šé‡è¦æ€§é‡‡æ ·æ¯”å€¼ï¼Œå‡å°‘è®­ç»ƒéœ‡è¡ã€‚

è‹¥å¥–åŠ±å‡½æ•°è®¾è®¡ä¸å½“ï¼Œä¼šå¯¼è‡´ç­–ç•¥æ›´æ–°æ··ä¹±ï¼Œè¦ä¹ˆæ–°æ—§ç­–ç•¥å·®å¼‚è¿‡å¤§å¼•å‘æ¢¯åº¦å¼‚å¸¸ï¼Œè¦ä¹ˆæ¨¡å‹è¿‡åº¦è¿åˆå•ä¸€å¥–åŠ±ç»´åº¦ï¼Œæœ€ç»ˆé™ä½è®­ç»ƒç¨³å®šæ€§ä¸æ”¶æ•›æ•ˆç‡ï¼Œç”šè‡³è®©GRPOçš„ç­–ç•¥ä¼˜åŒ–æœºåˆ¶å¤±æ•ˆï¼Œæ— æ³•è¾¾æˆé¢„æœŸè®­ç»ƒç›®æ ‡ã€‚

**ä¸è¿‡å¥–åŠ±å‡½æ•°è®¾è®¡æ€»å½’æ˜¯ä»»åŠ¡å¯¼å‘çš„ï¼Œå¥–åŠ±å‡½æ•°æ— éå°±æ˜¯å¯¹ç»“æœç­”æ¡ˆçš„è®¡ç®—ï¼Œå› æ­¤å½’æ ¹ç»“åº•æ˜¯ä»»åŠ¡ç›®æ ‡è®¾è®¡çš„é—®é¢˜ï¼Œ** äº‹å®ä¸Šæˆ‘ä»¬æœ€å¼€å§‹è€ƒè™‘äº†ä¸¤ç§æ–¹æ¡ˆï¼Œ

- ä¸€ç§æ˜¯ç°åœ¨æœ€ç»ˆçš„å®éªŒæ•ˆæœä¹Ÿå°±æ˜¯ç›´æ¥è¾“å‡ºå®Œæ•´çš„æ•°ç‹¬ç­”æ¡ˆ;
- å¦å¤–ä¸€ç§æ˜¯å¡«å……æ•°ç‹¬é—®é¢˜çš„ç©ºä½ï¼Œç„¶åæŒ‰ç…§é¡ºåºè¾“å‡ºç©ºçš„åœ°æ–¹å¯¹åº”çš„ç­”æ¡ˆã€‚

ç¬¬äºŒç§æ–¹æ¡ˆå¯¹äºå¤§æ¨¡å‹æ¥è¯´æ¯”è¾ƒéš¾ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä¸‹é¢çš„æç¤ºè¯ï¼ˆå·²ç»ä¼˜åŒ–äº†å¾ˆå¤šéçš„ï¼‰ï¼š

```python
PROMPT_TEMPLATE = """
## ä»»åŠ¡
å¡«å……4x4æ•°ç‹¬ä¸­çš„ç©ºç™½ä½ç½®â€œ_â€ï¼ŒæŒ‰ä»å·¦åˆ°å³ã€ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºè¾“å‡ºæ‰€æœ‰â€œ_â€å¯¹åº”çš„æ•°å­—åˆ—è¡¨ï¼Œæ•°å­—çš„æ•°é‡è¦å’Œâ€œ_â€çš„æ•°é‡ä¸€è‡´ã€‚

## è§„åˆ™
- æ¯è¡Œï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡
- æ¯åˆ—ï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡  
- æ¯ä¸ª2x2å®«æ ¼ï¼šæ•°å­—1-4å„å‡ºç°ä¸€æ¬¡

## è¾“å‡ºæ ¼å¼
åœ¨<think></think>ä¸­å¡«å…¥æ€è€ƒè¿‡ç¨‹
åœ¨<answer></answer>æ ‡ç­¾ä¸­ï¼Œä»…è¾“å‡ºâ€œ_â€ä½ç½®å¯¹åº”çš„æ•°å­—åˆ—è¡¨List[int]ã€‚

è¾“å‡ºæ ¼å¼ä¸¾ä¾‹ï¼ˆä»…åšå‚è€ƒï¼‰ï¼š
<think>
è¯¦ç»†æ¨ç†è¿‡ç¨‹ï¼Œè¯·ä½ ä¸€æ­¥ä¸€æ­¥æ€è€ƒï¼ŒåŒ…æ‹¬ï¼š
  - åˆå§‹é¢˜ç›®åˆ†æï¼ˆå·²çŸ¥æ•°å­—å’Œç©ºç™½ä½ç½®åˆ†å¸ƒï¼‰ã€‚
  - æ¯ä¸ªç©ºç™½ä½ç½®çš„å€™é€‰æ•°å­—åˆ†æåŠæ’é™¤ç†ç”±ã€‚
  - å¡«å……é¡ºåºå’Œé€»è¾‘ï¼ˆä¾‹å¦‚ï¼Œå¦‚ä½•é€šè¿‡è¡Œã€åˆ—ã€å®«æ ¼è§„åˆ™ç¡®å®šæ•°å­—ï¼‰ã€‚
  - æœ€ç»ˆéªŒè¯æ­¥éª¤ï¼Œç¡®ä¿æ— è§„åˆ™å†²çªã€‚
</think>
<answer>[1,2,3,4]</answer>

## é¢˜ç›®
{}
"""
```

ç„¶åçœ‹ä¸‹è¾“å‡ºçš„ç»“æœï¼Œå¤§å®¶å¯ä»¥æ„Ÿå—ä¸‹ğŸ˜‚ï¼Œè¿™æ˜¯7Bçš„æ¨¡å‹éƒ½ä¸è¡Œï¼Œ3Bå°±æ›´ä¸è¡Œäº†ï¼š

<div style="display:flex;justify-content:center;">
<figure style="text-align:center;margin:0;">
    <img src="./grpo_train/train20.png" style="width:100%">
</figure>
</div>

åæ¥æˆ‘è‡ªå·±æ€»ç»“è®¤ä¸ºæ˜¯ä»»åŠ¡å¤ªéš¾äº†ï¼Œæœ¬èº«æ•°ç‹¬è¿™ç§ä»»åŠ¡å¯¹å¤§æ¨¡å‹æ¥è¯´å°±æ˜¯æ¯”è¾ƒéš¾çš„ï¼Œç„¶åè¿™ä¸ªä»»åŠ¡æœ‰åˆ†äº†å¥½å¤šæ­¥ï¼Œä½†æ˜¯è®©å¤§æ¨¡å‹ä¸€æ¬¡æ€§è§£å†³ï¼Œ`len_completions`åˆè¿™ä¹ˆçŸ­ï¼Œæ‰€ä»¥æ•ˆæœå¾ˆä¸ç†æƒ³ã€‚

æ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆã€‚

å¯¹äºç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œ`reward`æˆ‘ä»¬æœ€å¼€å§‹ä¹Ÿæ˜¯æŒ‰ç…§å’Œç­”æ¡ˆçš„å¯¹åº”ç¨‹åº¦æ¥è®¡ç®—å‡†ç¡®åº¦ï¼Œä½†æ˜¯åæ¥æˆ‘ä»¬è®¤ä¸ºåˆ©ç”¨å‡†ç¡®çš„ç­”æ¡ˆæ¥è®¡ç®—å‡†ç¡®åº¦åªèƒ½è®©æ¨¡å‹å­¦ä¼šèƒŒç­”æ¡ˆè€Œå¿½è§†æ€è€ƒçš„èƒ½åŠ›ï¼Œæ¯•ç«Ÿ4\*4çš„æ•°ç‹¬ç¬¦åˆè§„åˆ™çš„ä¹Ÿå°±é‚£ä¹ˆå¤šç§ï¼Œå› æ­¤æˆ‘ä»¬æœ€ç»ˆå»æ‰äº†ç­”æ¡ˆçš„`reward`ï¼Œ**è®©æ¨¡å‹æ›´å…³æ³¨æ˜¯å¦éµå®ˆè§„åˆ™çš„`reward`ã€‚**

<div style="background:#e7f8ff;color:#000;padding:12px 16px;border-left:4px solid #20c0ff;">
æˆ‘ä»¬æ€»ç»“ä¸‹ï¼š

1. æœ€å¼€å§‹çš„ä»»åŠ¡ç›®æ ‡è¦è®¾è®¡å¥½
2. ä»»åŠ¡ä¸èƒ½è®¾è®¡çš„è¿‡äºå¤æ‚
3. rewardçš„è®¾è®¡è¦æ›´å…³æ³¨äºè®©æ¨¡å‹å­¦ä¼šæ€è€ƒ
4. <strong>åœ¨è®¾è®¡ä»»åŠ¡çš„æ—¶å€™å¯ä»¥å…ˆè®©æ¨¡å‹æ¨ç†ä¸‹ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿåšåˆ°åŸºæœ¬å›ç­”çš„èƒ½åŠ›</strong>

</div>

**4ã€åˆ†å¸ƒå¼è®­ç»ƒå‚æ•°**

trlçš„ä»£ç ä¸­ç»™äº†ç›¸å…³çš„å‚æ•°è„šæœ¬ï¼Œæ–‡ä»¶åœ¨ğŸ‘‰[è¿™é‡Œ](https://github.com/huggingface/trl/tree/main/trl/accelerate_configs)ï¼Œç»è¿‡æˆ‘ä»¬å®éªŒï¼Œ`deepspeed_zero2`å¯èƒ½è¿˜æ˜¯æ˜¾å­˜å ç”¨æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆä½¿ç”¨çš„æ˜¯`deepspeed_zero3`çš„è„šæœ¬ï¼Œè™½ç„¶é€Ÿåº¦å¯èƒ½æ¯”`zero2`æ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯æ•ˆæœå…¶å®å·®ä¸äº†å¤ªå¤šï¼Œè€Œä¸”æ˜¾å­˜å ç”¨ä¸ä¼šå¤ªå¤šã€‚

å¦‚æœå¤šæœºæˆ–è€…å…¶ä»–éœ€è¦å•ç‹¬è®¾ç½®çš„è¯ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤è¾“å‡ºï¼š

```bash
accelerate config
```

```yaml
compute_environment: LOCAL_MACHINE
debug: false
deepspeed_config:
  offload_optimizer_device: none
  offload_param_device: none
  zero3_init_flag: false
  zero3_save_16bit_model: true
  zero_stage: 3
distributed_type: DEEPSPEED
downcast_bf16: 'no'
enable_cpu_affinity: false
fsdp_config: {}
machine_rank: 0
main_training_function: main
mixed_precision: bf16
num_machines: 1
rdzv_backend: static
same_network: true
use_cpu: false
```

# å‚è€ƒèµ„æ–™

[1].[Teaching Language Models to Solve Sudoku ThroughÂ Reinforcement Learning](https://hrishbh.com/teaching-language-models-to-solve-sudoku-through-reinforcement-learning/)

[2].[https://huggingface.co/docs/trl/grpo_trainer](https://huggingface.co/docs/trl/grpo_trainer)

[3].[å›¾è§£å¤§æ¨¡å‹RLHFç³»åˆ—ä¹‹ï¼šäººäººéƒ½èƒ½çœ‹æ‡‚çš„PPOåŸç†ä¸æºç è§£è¯»](https://zhuanlan.zhihu.com/p/677607581)

[4].[DeepSeekMath: Pushing the Limits of Mathematical Reasoning in Open Language Models](https://arxiv.org/abs/2402.03300)

[5].[LLM-RL-Visualized](https://github.com/changyeyu/LLM-RL-Visualized)

[6].[Trust Region Policy Optimization](https://arxiv.org/abs/1502.05477)
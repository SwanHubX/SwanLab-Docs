# ms-swiftå¾®è°ƒQwen3å®ŒæˆåŒ»ç–—é—®ç­”ä»»åŠ¡

## ç®€ä»‹

â€‹	Qwen3 æ˜¯ Qwen ç³»åˆ—ä¸­æœ€æ–°ä¸€ä»£çš„å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ï¼Œæä¾›äº†ä¸€ç³»åˆ—å¯†é›†å‹å’Œä¸“å®¶æ··åˆï¼ˆMoEï¼‰æ¨¡å‹ã€‚åŸºäºå¹¿æ³›çš„è®­ç»ƒï¼ŒQwen3 åœ¨æ¨ç†ã€æŒ‡ä»¤æ‰§è¡Œã€ä»£ç†èƒ½åŠ›å’Œå¤šè¯­è¨€æ”¯æŒæ–¹é¢å®ç°äº†çªç ´æ€§è¿›å±•ï¼Œèƒ½åœ¨å•ä¸€æ¨¡å‹å†…æ— ç¼åˆ‡æ¢æ€è€ƒæ¨¡å¼ï¼ˆç”¨äºå¤æ‚çš„é€»è¾‘æ¨ç†ã€æ•°å­¦å’Œç¼–ç¨‹ï¼‰å’Œéæ€è€ƒæ¨¡å¼ï¼ˆç”¨äºé«˜æ•ˆçš„é€šç”¨å¯¹è¯ï¼‰ï¼Œç¡®ä¿åœ¨å„ç§åœºæ™¯ä¸‹çš„æœ€ä½³æ€§èƒ½ã€‚

â€‹	ms-swift æ˜¯ ModelScope ç¤¾åŒºæä¾›çš„å®˜æ–¹æ¡†æ¶ï¼Œç”¨äºå¾®è°ƒå’Œéƒ¨ç½²å¤§å‹è¯­è¨€æ¨¡å‹å’Œå¤šæ¨¡æ€å¤§å‹æ¨¡å‹ã€‚å®ƒç›®å‰æ”¯æŒ 450+ å¤§å‹æ¨¡å‹å’Œ 150+ å¤šæ¨¡æ€å¤§å‹æ¨¡å‹çš„è®­ç»ƒï¼ˆé¢„è®­ç»ƒã€å¾®è°ƒã€äººå·¥å¯¹é½ï¼‰ã€æ¨ç†ã€è¯„ä¼°ã€é‡åŒ–å’Œéƒ¨ç½²ï¼Œéå¸¸ä¾¿åˆ©ã€‚

â€‹	æœ¬æ¬¡æ•™ç¨‹å°±ä½¿ç”¨ms-swiftæ¡†æ¶å¯¹Qwen3-0.6Bæ¨¡å‹è¿›è¡ŒåŒ»ç–—é—®ç­”é¢†åŸŸå¾®è°ƒï¼Œå¸Œæœ›æœ¬æ¬¡æ•™ç¨‹èƒ½è®©è¯»è€…è½»æ¾ä¸Šæ‰‹å®è·µã€‚



## é“¾æ¥èµ„æ–™

ä½œè€…ä¿¡æ¯ï¼šæƒ…æ„Ÿæœºå™¨å®éªŒå®¤ç ”ç©¶å‘˜-æé¦¨é›¨ é‚®ç®±ï¼šwind.340171@gmail.com

æ¨¡å‹åœ°å€ï¼šQwen3-0.6Bï¼š[é­”æ­ç¤¾åŒº](https://www.modelscope.cn/models/Qwen/Qwen3-0.6B)

æ•°æ®é›†åœ°å€ï¼šdelicate_medical_r1_dataï¼š[é­”æ­ç¤¾åŒº](https://www.modelscope.cn/datasets/krisfu/delicate_medical_r1_data/dataPeview)

ä»£ç åœ°å€ï¼š[github](https://github.com/828Tina/qwen3-ft-swift)

å¯è§†åŒ–å·¥å…·SwanLabé¡¹ç›®åœ°å€ï¼š[SwanLabè®­ç»ƒæŒ‡æ ‡è§‚æµ‹ç»“æœæ›²çº¿å›¾](https://swanlab.cn/@LiXinYu/swift-robot/overview)

> å‹æƒ…é“¾æ¥ï¼š
>
> SwanLabå®˜æ–¹æ–‡æ¡£ï¼ŒåŠ©ä½ è½»æ¾å¼€å¯æ·±åº¦å­¦ä¹ ä¹‹æ—…ã€‚
>
> 1. [æ¡†æ¶é›†æˆæ–‡æ¡£](https://docs.swanlab.cn/guide_cloud/integration/)ï¼šSwanLabå·²ç»é›†æˆTransformersã€LLaMA Factoryã€Pytorchç­‰ä¸»æµæ¡†æ¶ï¼Œå¹¶æŒç»­æ›´æ–°
> 2. [å®æˆ˜æ¡ˆä¾‹](https://docs.swanlab.cn/examples/hello_world.html)ï¼šSwanLabæä¾›äº†ä¸°å¯Œçš„æ¨¡å‹è®­ç»ƒå®æˆ˜æ•™ç¨‹ï¼ŒåŠ©åŠ›ç”¨æˆ·å¿«é€ŸæŒæ¡æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„è¦ç‚¹



## è®­ç»ƒä»£ç 

### 1ã€ç¯å¢ƒé…ç½®

**1ã€å®‰è£…ms-swiftï¼ˆ>=3.1.1ï¼‰ï¼š**

```Bash
pip install ms-swift
```

**2ã€å®‰è£…swanlabï¼š**

```Bash
pip install swanlab
```

***3ã€å®‰è£…deepspeed***

å¦‚æœé‡‡ç”¨å•æœºå¤šå¡åˆ†å¸ƒå¼è®­ç»ƒæ–¹å¼ï¼Œå¯ä»¥é€‰æ‹©DeepSpeed ZeRO2/ZeRO3ã€‚

```Bash
pip install deepspeed
```

**ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç è®¾ç½®ç¯å¢ƒ**

```Bash
pip install -r requirement.txt
```



### 2ã€æ•°æ®é›†å¤„ç†

åŸå§‹æ•°æ®é›†ä½¿ç”¨çš„æ˜¯ delicate_medical_r1_data æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†ä¸»è¦è¢«ç”¨äºåŒ»å­¦å¯¹è¯æ¨¡å‹ã€‚

æ•°æ®é›†é“¾æ¥ï¼š

https://modelscope.cn/datasets/krisfu/delicate_medical_r1_data

è¯¥æ•°æ®é›†ç”±2000å¤šæ¡æ•°æ®ç»„æˆï¼Œæ¯æ¡æ•°æ®åŒ…å«Instructionã€questionã€thinkã€answerã€metricsäº”åˆ—ï¼š

![](./qwen3-ft-swift/dataset.png)

è¿™é‡Œæˆ‘ä»¬åªå–questionã€thinkã€answerè¿™ä¸‰åˆ—ï¼š

- **`questionï¼š`**`ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼Œå³æ¨¡å‹çš„è¾“å…¥`
- **`thinkï¼š`**`æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹ã€‚å¤§å®¶å¦‚æœç”¨è¿‡DeepSeek R1çš„è¯ï¼Œå›å¤ä¸­æœ€å¼€å§‹çš„æ€è€ƒè¿‡ç¨‹å°±æ˜¯è¿™ä¸ª`
- **`answerï¼š`**`æ¨¡å‹æ€è€ƒå®Œæˆåï¼Œå›å¤çš„å†…å®¹`

æˆ‘ä»¬çš„è®­ç»ƒä»»åŠ¡ï¼Œä¾¿æ˜¯å¸Œæœ›å¾®è°ƒåçš„å¤§æ¨¡å‹ï¼Œèƒ½å¤Ÿæ ¹æ®`question`ï¼Œç»™ç”¨æˆ·ä¸€ä¸ª`think`+`answer`çš„ç»„åˆå›å¤ï¼Œå¹¶ä¸”`think`å’Œ`answer`åœ¨ç½‘é¡µä¸Šçš„å±•ç¤ºæœ‰åŒºåˆ†ã€‚

åŒæ—¶ä¹Ÿéœ€è¦æ³¨æ„ms-swiftå®˜æ–¹å¯¹æ•°æ®é›†æ ¼å¼æœ‰è¦æ±‚ï¼Œæ•°æ®é›†æ ¼å¼é“¾æ¥å¦‚ä¸‹ï¼š

[è‡ªå®šä¹‰æ•°æ®é›†](https://swift.readthedocs.io/zh-cn/latest/Customization/è‡ªå®šä¹‰æ•°æ®é›†.html)

å…¶ä¸­åŒ…å«å››ç§æ ‡å‡†æ ¼å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼š

```JSON
{"messages": 
    [
        {"role": "system", "content": "<system>"}, 
        {"role": "user", "content": "<query1>"}, 
        {"role": "assistant", "content": "<response1>"}, 
        {"role": "user", "content": "<query2>"},
         {"role": "assistant", "content": "<response2>"}
     ]
}
```

åœ¨è®­ç»ƒä»£ç æ‰§è¡Œæ—¶ï¼Œä¼šå°†`think`å’Œ`answer`æŒ‰ä¸‹é¢è¿™æ ·çš„æ ¼å¼ç»„åˆæˆä¸€æ¡å®Œæ•´å›å¤ï¼š

```Plain
<think>å—¯ï¼Œç”¨æˆ·çš„é—®é¢˜æ˜¯å…³äºç—…äººå‡ºç°æ´»åŠ¨æ€§å‡ºè¡€æ—¶åº”é‡‡å–å“ªäº›ä¸€èˆ¬å¤„ç†æªæ–½ï¼Œ...</think>
é¦–å…ˆï¼Œæ‚¨çˆ¶äº²éœ€è¦å§åºŠä¼‘æ¯ï¼Œæ´»åŠ¨æ€§å‡ºè¡€æœŸé—´æš‚æ—¶ä¸è¦è¿›é£Ÿã€‚ä¸ºäº†...
```

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸‹è½½æ•°æ®é›†ï¼Œå¹¶è¿›è¡Œå¿…è¦çš„æ ¼å¼è½¬æ¢ã€‚

è¿™ä¸ªæµç¨‹éå¸¸ç®€å•ï¼Œæ‰§è¡Œä¸‹é¢çš„ä»£ç å³å¯ï¼š

```Bash
python data.py
```

æœ€ç»ˆä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼šè®­ç»ƒé›†&éªŒè¯é›†ï¼Œåˆ†åˆ«å­˜æ”¾äºdataæ–‡ä»¶å¤¹ä¸­ã€‚

./data/train.jsonl

./data/val.jsonl

æ¨¡å‹å¾®è°ƒæ—¶ç›´æ¥ä½¿ç”¨å­˜æ”¾åœ°å€å³å¯ã€‚



### 3ã€è®­ç»ƒä»£ç 

è¯¥è®­ç»ƒä½¿ç”¨CLIä»£ç æ¥å®ç°ï¼Œms-swiftè¿˜æä¾›äº†UIè¿˜æœ‰Pythonä»£ç å®ç°ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•è¯•åˆ«çš„æ–¹æ³•ã€‚å‚è€ƒé“¾æ¥ğŸ‘‰[SwanLab](https://docs.swanlab.cn/guide_cloud/integration/integration-swift.html)ã€‚

è®­ç»ƒè„šæœ¬åˆ†åˆ«æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ï¼š

1. train.sh
2. train_deepspeed.sh

ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯åœ¨å•å¡3090ä¸Šå¯¹Qwen3-0.6Bè¿›è¡Œè‡ªæˆ‘è®¤çŸ¥å¾®è°ƒï¼Œæ€»è®¡11åˆ†é’Ÿï¼Œå¯åŠ¨è®­ç»ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```Bash
bash train.sh
```

ç¬¬äºŒä¸ªæ–‡ä»¶æ˜¯å¤šå¡3090ä¸ŠåŸºäºdeepspeed zero2è¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒï¼Œæ€»è®¡ä¸¤åˆ†é’Ÿï¼Œå¯åŠ¨ä»£ç å¦‚ä¸‹ï¼š

```Bash
bash train_deepspeed.sh
```

çœ‹åˆ°ä¸‹é¢çš„è¿›åº¦æ¡å³ä»£è¡¨è®­ç»ƒå¼€å§‹ï¼š

![](./qwen3-ft-swift/swanlab-train.png)

---

**æ³¨æ„ï¼š**

å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨SwanLabï¼Œé‚£ä¹ˆè¿˜éœ€è¦å»**https://swanlab.cn**ä¸Šæ³¨å†Œä¸€ä¸ªè´¦å·ï¼Œåœ¨***ç”¨æˆ·è®¾ç½®(å³ä¸Šè§’)***é¡µé¢å¤åˆ¶ä½ çš„API Keyï¼Œç„¶ååœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œé€‰æ‹©ã€2ã€‘ï¼Œç„¶åç²˜è´´è¿›å»å³å¯ï¼š

![](./qwen3-ft-swift/swanlab-login.png)

---

è®­ç»ƒæœ€ç»ˆä¿å­˜çš„æ¨¡å‹æƒé‡æ–‡ä»¶åœ¨outputä¸­ï¼Œæ¯ç»è¿‡ä¸€å®šæ­¥éª¤å°±ä¼šä¿å­˜ä¸€æ¬¡æƒé‡ä¿¡æ¯ï¼Œä¼šè‡ªåŠ¨ä¿å­˜æˆåŒ…å«checkpointçš„æ–‡ä»¶å¤¹ï¼Œæ¨¡å‹æ¨ç†æ—¶éœ€è¦ç”¨åˆ°æœ€åä¸€ä¸ªcheckpointã€‚

### 4ã€æ¨ç†æµ‹è¯•

è®­ç»ƒå®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯¹è®­ç»ƒåçš„æƒé‡è¿›è¡Œæ¨ç†ï¼š

- è¿™é‡Œçš„`--adapters`éœ€è¦æ›¿æ¢æˆè®­ç»ƒç”Ÿæˆçš„last checkpointæ–‡ä»¶å¤¹ã€‚ç”±äºadaptersæ–‡ä»¶å¤¹ä¸­åŒ…å«äº†è®­ç»ƒçš„å‚æ•°æ–‡ä»¶`args.json`ï¼Œå› æ­¤ä¸éœ€è¦é¢å¤–æŒ‡å®š`--model`ï¼Œ`--system`ï¼Œswiftä¼šè‡ªåŠ¨è¯»å–è¿™äº›å‚æ•°ã€‚å¦‚æœè¦å…³é—­æ­¤è¡Œä¸ºï¼Œå¯ä»¥è®¾ç½®`--load_args false`ã€‚

å¯åŠ¨ä»£ç å¦‚ä¸‹ï¼š

```Bash
bash inference.sh
```

å¦‚æœæ¨ç†é€Ÿåº¦è¿‡æ…¢ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨vllmè¿›è¡Œæ¨ç†åŠ é€Ÿï¼Œä»£ç å¦‚ä¸‹ï¼š

```Bash
# merge-loraå¹¶ä½¿ç”¨vLLMè¿›è¡Œæ¨ç†åŠ é€Ÿ
CUDA_VISIBLE_DEVICES=0 \
swift infer \
    --adapters output/vx-xxx/checkpoint-xxx \
    --stream true \
    --merge_lora true \
    --infer_backend vllm \
    --max_model_len 8192 \
    --temperature 0 \
    --max_new_tokens 2048
```

## SwanLabç»“æœè§‚æµ‹

![](./qwen3-ft-swift/train-eval.png)

å¯ä»¥çœ‹åˆ°æ ¸å¿ƒè¦å…³æ³¨çš„æŒ‡æ ‡æœ‰**train loss**å’Œ**eval lossã€‚**

è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹å§ï¼ä½¿ç”¨**ã€Œåˆ›å»ºæŠ˜çº¿å›¾ã€**åŠŸèƒ½ï¼ŒæŠŠtrain losså’Œeval lossæ”¾åˆ°ä¸€å¼ å›¾ä¸Šï¼š

![](./qwen3-ft-swift/swanlab-results.png)

ç»¿è‰²çš„æ˜¯train lossï¼Œè“è‰²çš„æ˜¯eval lossã€‚å¯ä»¥çœ‹åˆ°train losså‘ˆç°ç¼“æ…¢ä¸‹é™çš„è¶‹åŠ¿ï¼Œå¦‚æœlogging stepsè¶³å¤Ÿå¤šï¼Œåº”è¯¥ä¼šåœ¨epochçš„äº¤æ›¿é˜¶æ®µï¼Œé˜¶æ¢¯å¼ä¸‹é™ï¼›eval losså‘ˆç°æ­£å¸¸ä¸‹é™è¶‹åŠ¿ï¼Œæ²¡æœ‰è¿‡æ‹Ÿåˆç°è±¡ã€‚

ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹çœ‹æ¨ç†æ•ˆæœï¼š

![](./qwen3-ft-swift/inference.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œå¾®è°ƒåçš„æ¨¡å‹æ˜ç¡®åœ°æœ‰äº†æ€è€ƒè¿‡ç¨‹ï¼Œå¹¶ä¸”åœ¨æ€è€ƒè¿‡ç¨‹çš„å‰åå¢åŠ äº†thinkæ ‡ç­¾ã€‚

## F&A

### 1ã€é­”æ­ç¤¾åŒºä¸‹è½½çš„æ•°æ®é›†ç”¨ä¸äº†

ç”±äºæœ¬èº«æ•°æ®é›†æ˜¯æ¥æºäºhuggingfaceï¼Œé­”æ­ç¤¾åŒºä¸Šä¼ çš„æ•°æ®é›†ä¼šæœ‰dataset_infos.jsonæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸Šä¼ æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨ä»¥åœ¨æ•°æ®é¢„è§ˆåŠŸèƒ½é‡Œå±•ç¤ºæ•°æ®é›†ä¸­æ¯ä¸€ç±»åˆ«æ ‡ç­¾ï¼Œä½†æ˜¯ä¸ç¬¦åˆhuggingfaceçš„æ ¼å¼ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™ä¼šè°ƒç”¨datasetsåº“ï¼Œç„¶åä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š

ä»£ç ï¼š

```python
from datasets import load_dataset

DATA_PATH = '/data/nvme0/textvqa_bbox'
ds = load_dataset(DATA_PATH,split='train')
```

æŠ¥é”™ï¼š

```python
TypeError: Value.__init__() missing 1 required positional argument: 'dtype'
```

è§£å†³ï¼š

åˆ æ‰ä¸‹è½½åˆ°æœ¬åœ°çš„æ•°æ®é›†æ–‡ä»¶é‡Œçš„dataset_infos.jsonæ–‡ä»¶ã€‚



### 2ã€ç¯å¢ƒé…ç½®é—®é¢˜

modelscopeå’Œdatasetså¦‚æœç‰ˆæœ¬å¯¹ä¸ä¸Šï¼Œä¼šæŠ¥ç¯å¢ƒçš„é”™è¯¯

```pyt
ImportError: cannot import name 'OfflineModeIsEnabled' from 'datasets.utils.file_utils' 
```

è¿™ä¸ªé”™è¯¯è¡¨æ˜åœ¨å°è¯•ä» `datasets.utils.file_utils` æ¨¡å—ä¸­å¯¼å…¥ `OfflineModeIsEnabled` æ—¶å¤±è´¥äº†ã€‚è¿™é€šå¸¸æ˜¯å› ä¸º `datasets` åº“çš„ç‰ˆæœ¬ä¸ `modelscope` åº“çš„ä¾èµ–ä¸åŒ¹é…å¯¼è‡´çš„ã€‚

æˆ‘é…å¥½äº†ç¯å¢ƒï¼Œå¯ä»¥ç›´æ¥ç”¨requirement.txtï¼Œæˆ–è€…å‚è€ƒä¸‹é¢çš„ç¯å¢ƒã€‚

```python
datasets==3.2.0
modelscope==1.22.0 
```



## å‚è€ƒèµ„æ–™

[https://github.com/modelscope/ms-swift/tree/main](https://github.com/modelscope/ms-swift/tree/main)

[ms-swiftè‡ªå®šä¹‰æ•°æ®é›†æŒ‡å—](https://swift.readthedocs.io/zh-cn/latest/Customization/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E9%9B%86.html)





